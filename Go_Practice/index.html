<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>colly介绍 | SuperEggs</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="shortcut icon" href="/log.ico" type="image/jpg">
    <script>
            var _hmt = _hmt || [];
            (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    <script src="/js/jquery-3.5.min.js"></script>
    <script src="/js/cursor.min.js"></script>
    <meta name="description" content="分享生活高效技能,保持勇敢，坚持有趣，生命不息，折腾不止！">
    <meta property="og:site_name" content="SuperEggs">
    <meta property="og:title" content="colly介绍">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/Go_Practice/">
    <meta name="twitter:title" content="colly介绍">
    <meta name="twitter:url" content="/Go_Practice/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="keywords" content="html,css,jquery,thinkphp,laravel,docker,linux,manjaro">
    <meta name="auther" content="SuperEggs">
    <link rel="preload" href="/assets/css/0.styles.5f689f29.css" as="style"><link rel="preload" href="/assets/js/app.693e6c19.js" as="script"><link rel="preload" href="/assets/js/2.3304c2e1.js" as="script"><link rel="preload" href="/assets/js/31.a273a940.js" as="script"><link rel="prefetch" href="/assets/js/10.34123518.js"><link rel="prefetch" href="/assets/js/11.f0e24eb8.js"><link rel="prefetch" href="/assets/js/12.5e75a974.js"><link rel="prefetch" href="/assets/js/13.db0bf381.js"><link rel="prefetch" href="/assets/js/14.ed324319.js"><link rel="prefetch" href="/assets/js/15.f40e8254.js"><link rel="prefetch" href="/assets/js/16.d8f963c5.js"><link rel="prefetch" href="/assets/js/17.250470cc.js"><link rel="prefetch" href="/assets/js/18.5161c52b.js"><link rel="prefetch" href="/assets/js/19.afb8dd7a.js"><link rel="prefetch" href="/assets/js/20.c8248808.js"><link rel="prefetch" href="/assets/js/21.e818d83d.js"><link rel="prefetch" href="/assets/js/22.69d0a99c.js"><link rel="prefetch" href="/assets/js/23.92b9837f.js"><link rel="prefetch" href="/assets/js/24.124a82a4.js"><link rel="prefetch" href="/assets/js/25.1c0271e6.js"><link rel="prefetch" href="/assets/js/26.34e44644.js"><link rel="prefetch" href="/assets/js/27.4f89b112.js"><link rel="prefetch" href="/assets/js/28.82ed427e.js"><link rel="prefetch" href="/assets/js/29.64fae044.js"><link rel="prefetch" href="/assets/js/3.1c0cc69b.js"><link rel="prefetch" href="/assets/js/30.dc7d1b9b.js"><link rel="prefetch" href="/assets/js/32.ca99c448.js"><link rel="prefetch" href="/assets/js/33.4129d67d.js"><link rel="prefetch" href="/assets/js/34.a49e24e6.js"><link rel="prefetch" href="/assets/js/35.4ba458c0.js"><link rel="prefetch" href="/assets/js/36.7412ff8c.js"><link rel="prefetch" href="/assets/js/37.35c3a72c.js"><link rel="prefetch" href="/assets/js/38.ebf390fb.js"><link rel="prefetch" href="/assets/js/39.6b308832.js"><link rel="prefetch" href="/assets/js/4.e5a930e9.js"><link rel="prefetch" href="/assets/js/40.968d571d.js"><link rel="prefetch" href="/assets/js/41.a1f587bf.js"><link rel="prefetch" href="/assets/js/42.9f358bc3.js"><link rel="prefetch" href="/assets/js/43.4f19f41e.js"><link rel="prefetch" href="/assets/js/44.a27ad98a.js"><link rel="prefetch" href="/assets/js/45.fb26a2d8.js"><link rel="prefetch" href="/assets/js/46.aa66c6d7.js"><link rel="prefetch" href="/assets/js/47.00ae1556.js"><link rel="prefetch" href="/assets/js/48.699e8e33.js"><link rel="prefetch" href="/assets/js/49.0f79ef04.js"><link rel="prefetch" href="/assets/js/5.2d78753d.js"><link rel="prefetch" href="/assets/js/50.2428dcc2.js"><link rel="prefetch" href="/assets/js/51.829dcccc.js"><link rel="prefetch" href="/assets/js/52.f2dfda6b.js"><link rel="prefetch" href="/assets/js/53.225de2db.js"><link rel="prefetch" href="/assets/js/54.b91ed453.js"><link rel="prefetch" href="/assets/js/55.25bacde7.js"><link rel="prefetch" href="/assets/js/56.2a58cece.js"><link rel="prefetch" href="/assets/js/57.48eab866.js"><link rel="prefetch" href="/assets/js/58.5cf8ca6e.js"><link rel="prefetch" href="/assets/js/59.458178cc.js"><link rel="prefetch" href="/assets/js/6.66329e4b.js"><link rel="prefetch" href="/assets/js/60.7898b9b9.js"><link rel="prefetch" href="/assets/js/61.5f651468.js"><link rel="prefetch" href="/assets/js/62.cd190cb0.js"><link rel="prefetch" href="/assets/js/63.0d472232.js"><link rel="prefetch" href="/assets/js/64.e8a8ffe7.js"><link rel="prefetch" href="/assets/js/65.8a66ff7d.js"><link rel="prefetch" href="/assets/js/66.0492741b.js"><link rel="prefetch" href="/assets/js/67.204dadcb.js"><link rel="prefetch" href="/assets/js/68.7d5b0a8f.js"><link rel="prefetch" href="/assets/js/69.ed735059.js"><link rel="prefetch" href="/assets/js/7.44229983.js"><link rel="prefetch" href="/assets/js/70.0f643f0b.js"><link rel="prefetch" href="/assets/js/71.a226be62.js"><link rel="prefetch" href="/assets/js/8.51a4d2f9.js"><link rel="prefetch" href="/assets/js/9.ee30d1ab.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5f689f29.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/log.png" alt="SuperEggs" class="logo"> <span class="site-name can-hide">SuperEggs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具软件" class="dropdown-title"><span class="title">工具软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具软件" class="mobile-dropdown-title"><span class="title">工具软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Tool/windows.html" class="nav-link">
  Windows
</a></li><li class="dropdown-item"><!----> <a href="/Tool/01brew.html" class="nav-link">
  Brew
</a></li><li class="dropdown-item"><!----> <a href="/Tool/02yarn.html" class="nav-link">
  Yarn
</a></li><li class="dropdown-item"><!----> <a href="/Tool/git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/Tool/goland.html" class="nav-link">
  Goland
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="go" class="dropdown-title"><span class="title">go</span> <span class="arrow down"></span></button> <button type="button" aria-label="go" class="mobile-dropdown-title"><span class="title">go</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Go/" class="nav-link">
  go Wiki
</a></li><li class="dropdown-item"><!----> <a href="/Go_Practice/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  go 实践
</a></li><li class="dropdown-item"><!----> <a href="/Go_Packages/" class="nav-link">
  go 包
</a></li></ul></div></div><div class="nav-item"><a href="/Laravel/" class="nav-link">
  Laravel
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发环境" class="dropdown-title"><span class="title">开发环境</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发环境" class="mobile-dropdown-title"><span class="title">开发环境</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Wamp/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/Linux/Config.html" class="nav-link">
  配置文件
</a></li><li class="dropdown-item"><!----> <a href="/Linux/Tool.html" class="nav-link">
  生产工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Code" class="dropdown-title"><span class="title">Code</span> <span class="arrow down"></span></button> <button type="button" aria-label="Code" class="mobile-dropdown-title"><span class="title">Code</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Html
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Code/Css.html" class="nav-link">
  Css样式收藏
</a></li><li class="dropdown-subitem"><a href="/Code/Layui.html" class="nav-link">
  Layui笔记
</a></li><li class="dropdown-subitem"><a href="/Code/Javascript.html" class="nav-link">
  Javascript手册
</a></li><li class="dropdown-subitem"><a href="/Code/Menu.html" class="nav-link">
  在线手册
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/Code/VueNote.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><h4>
          Php
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Code/Php.html" class="nav-link">
  Php使用技巧
</a></li><li class="dropdown-subitem"><a href="/Code/Thinkphp.html" class="nav-link">
  ThinkPhp
</a></li><li class="dropdown-subitem"><a href="/Code/LaraCode.html" class="nav-link">
  LaraCode
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/MyNote/" class="nav-link">
  MyNote
</a></div><div class="nav-item"><a href="/WebNote/" class="nav-link">
  WebNote
</a></div><div class="nav-item"><a href="/EMS/" class="nav-link">
  EMS
</a></div> <a href="https://github.com/super-eggs/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具软件" class="dropdown-title"><span class="title">工具软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具软件" class="mobile-dropdown-title"><span class="title">工具软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Tool/windows.html" class="nav-link">
  Windows
</a></li><li class="dropdown-item"><!----> <a href="/Tool/01brew.html" class="nav-link">
  Brew
</a></li><li class="dropdown-item"><!----> <a href="/Tool/02yarn.html" class="nav-link">
  Yarn
</a></li><li class="dropdown-item"><!----> <a href="/Tool/git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/Tool/goland.html" class="nav-link">
  Goland
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="go" class="dropdown-title"><span class="title">go</span> <span class="arrow down"></span></button> <button type="button" aria-label="go" class="mobile-dropdown-title"><span class="title">go</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Go/" class="nav-link">
  go Wiki
</a></li><li class="dropdown-item"><!----> <a href="/Go_Practice/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  go 实践
</a></li><li class="dropdown-item"><!----> <a href="/Go_Packages/" class="nav-link">
  go 包
</a></li></ul></div></div><div class="nav-item"><a href="/Laravel/" class="nav-link">
  Laravel
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发环境" class="dropdown-title"><span class="title">开发环境</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发环境" class="mobile-dropdown-title"><span class="title">开发环境</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Wamp/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/Linux/Config.html" class="nav-link">
  配置文件
</a></li><li class="dropdown-item"><!----> <a href="/Linux/Tool.html" class="nav-link">
  生产工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Code" class="dropdown-title"><span class="title">Code</span> <span class="arrow down"></span></button> <button type="button" aria-label="Code" class="mobile-dropdown-title"><span class="title">Code</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Html
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Code/Css.html" class="nav-link">
  Css样式收藏
</a></li><li class="dropdown-subitem"><a href="/Code/Layui.html" class="nav-link">
  Layui笔记
</a></li><li class="dropdown-subitem"><a href="/Code/Javascript.html" class="nav-link">
  Javascript手册
</a></li><li class="dropdown-subitem"><a href="/Code/Menu.html" class="nav-link">
  在线手册
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/Code/VueNote.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><h4>
          Php
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Code/Php.html" class="nav-link">
  Php使用技巧
</a></li><li class="dropdown-subitem"><a href="/Code/Thinkphp.html" class="nav-link">
  ThinkPhp
</a></li><li class="dropdown-subitem"><a href="/Code/LaraCode.html" class="nav-link">
  LaraCode
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/MyNote/" class="nav-link">
  MyNote
</a></div><div class="nav-item"><a href="/WebNote/" class="nav-link">
  WebNote
</a></div><div class="nav-item"><a href="/EMS/" class="nav-link">
  EMS
</a></div> <a href="https://github.com/super-eggs/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Go_Practice</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Go_Practice/Chromedp.html" class="sidebar-link">Chromedp 小尝试</a></li><li><a href="/Go_Practice/Cobra.html" class="sidebar-link">golang命令行库Cobra的使用</a></li><li><a href="/Go_Practice/" aria-current="page" class="active sidebar-link">colly介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Go_Practice/#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/Go_Practice/#_1-爬取简书首页文章列表" class="sidebar-link">1. 爬取简书首页文章列表</a></li><li class="sidebar-sub-header"><a href="/Go_Practice/#_2-爬取文章列表和详情" class="sidebar-link">2.爬取文章列表和详情</a></li><li class="sidebar-sub-header"><a href="/Go_Practice/#_3-爬取需要登录的网页" class="sidebar-link">3. 爬取需要登录的网页</a></li><li class="sidebar-sub-header"><a href="/Go_Practice/#_4-内存任务队列" class="sidebar-link">4. 内存任务队列</a></li><li class="sidebar-sub-header"><a href="/Go_Practice/#_5-redis任务队列" class="sidebar-link">5. redis任务队列</a></li><li class="sidebar-sub-header"><a href="/Go_Practice/#_6-配置代理" class="sidebar-link">6.配置代理</a></li><li class="sidebar-sub-header"><a href="/Go_Practice/#检测-ip" class="sidebar-link">检测 ip</a></li><li class="sidebar-sub-header"><a href="/Go_Practice/#用法" class="sidebar-link">用法</a></li><li class="sidebar-sub-header"><a href="/Go_Practice/#待采集的免费代理-ip-源" class="sidebar-link">待采集的免费代理 ip 源</a></li></ul></li><li><a href="/Go_Practice/Singo.html" class="sidebar-link">Singo 使用手册</a></li><li><a href="/Go_Practice/go-gin-api.html" class="sidebar-link">go-gin-api</a></li><li><a href="/Go_Practice/goquery.html" class="sidebar-link">goquery selector(选择器) 示例</a></li><li><a href="/Go_Practice/gui-walk.html" class="sidebar-link">使用golang制作GUI图形界面</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="colly-介绍"><a href="#colly-介绍" class="header-anchor">#</a> Colly 介绍</h1> <p>colly 是 Go 实现的比较有名的一款爬虫框架，而且 Go 在高并发和分布式场景的优势也正是爬虫技术所需要的。它的主要特点是轻量、快速，设计非常优雅，并且分布式的支持也非常简单，易于扩展。</p> <p>官网地址：<a href="https://links.jianshu.com/go?to=http%3A%2F%2Fgo-colly.org%2F" target="_blank" rel="noopener noreferrer">http://go-colly.org/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>包地址：<code>import &quot;github.com/gocolly/colly&quot;</code></p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>go get -u github.com/gocolly/colly/<span class="token punctuation">..</span>.
</code></pre></div><p>一个简单的例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Visiting&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">&quot;http://go-colly.org/&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用方式概括下来主要有三步：</p> <ol><li>创建一个采集器</li> <li>注册回调函数</li> <li>访问具体网站</li></ol> <p>创建采集器时可以指定一些配置参数，如useragent，爬取深度及日志等</p> <div class="language-go extra-class"><pre class="language-go"><code>colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>colly<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 colly<span class="token punctuation">.</span><span class="token function">MaxDepth</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
colly<span class="token punctuation">.</span><span class="token function">Debugger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>debug<span class="token punctuation">.</span>LogDebugger<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>回调函数共有7 种</p> <table><thead><tr><th>名称</th> <th>说明</th> <th>参数1</th> <th>参数2</th></tr></thead> <tbody><tr><td>OnRequest</td> <td>请求前调用</td> <td>*colly.Request</td> <td></td></tr> <tr><td>OnError</td> <td>请求发生错误时调用</td> <td>*colly.Response</td> <td>error</td></tr> <tr><td>OnResponseHeaders</td> <td>收到响应头后调用</td> <td>colly.Response</td> <td></td></tr> <tr><td>OnResponse</td> <td>收到响应后调用</td> <td>colly.Response</td> <td></td></tr> <tr><td>OnHTML</td> <td>响应内容是HTML时调用</td> <td>xpath表达式</td> <td>func(e *colly.HTMLElement)</td></tr> <tr><td>OnXML</td> <td>响应内容是XML时调用</td> <td>xpath表达式</td> <td>func(e *colly.XMLElement)</td></tr> <tr><td>OnScraped</td> <td>在OnXML之后调用</td> <td>func(r *colly.Response)</td> <td></td></tr></tbody></table> <blockquote><p>OnHTML回调可以注册多个，匹配不同的xpath表达式</p></blockquote> <h2 id="_1-爬取简书首页文章列表"><a href="#_1-爬取简书首页文章列表" class="header-anchor">#</a> 1. 爬取简书首页文章列表</h2> <p>通过浏览器开发者工具查看jianshu.com结构如下</p> <p><img src="https://i.loli.net/2021/04/20/UREa3O7YJH8CsIn.png" alt="image-20210420104600136"></p> <p>文章列表为ul标签，中间每一项是li标签，li中包含content，content中包含title，abstract和meta标签</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly/debug&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>colly<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colly<span class="token punctuation">.</span><span class="token function">MaxDepth</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colly<span class="token punctuation">.</span><span class="token function">Debugger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>debug<span class="token punctuation">.</span>LogDebugger<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//文章列表</span>
    c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;ul[class='note-list']&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//列表中每一项</span>
            e<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> item <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//文章链接</span>
            href <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">&quot;div[class='content'] &gt; a[class='title']&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">//文章标题</span>
            title <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">&quot;div[class='content'] &gt; a[class='title']&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">//文章摘要</span>
            summary <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">&quot;div[class='content'] &gt; p[class='abstract']&quot;</span><span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> href<span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>summary<span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.jianshu.com&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-爬取文章列表和详情"><a href="#_2-爬取文章列表和详情" class="header-anchor">#</a> 2.爬取文章列表和详情</h2> <blockquote><p>文章列表和1方式一样，文章详情通过创建新的采集器访问详情页面</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c1 <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>colly<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colly<span class="token punctuation">.</span><span class="token function">MaxDepth</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    c2 <span class="token operator">:=</span> c1<span class="token punctuation">.</span><span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//异步</span>
    c2<span class="token punctuation">.</span>Async <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">//限速</span>
    c2<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>colly<span class="token punctuation">.</span>LimitRule<span class="token punctuation">{</span>
        DomainRegexp<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        DomainGlob<span class="token punctuation">:</span>   <span class="token string">&quot;*.jianshu.com/p/*&quot;</span><span class="token punctuation">,</span>
        Delay<span class="token punctuation">:</span>        <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
        RandomDelay<span class="token punctuation">:</span>  <span class="token number">0</span><span class="token punctuation">,</span>
        Parallelism<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//采集器1，获取文章列表</span>
    c1<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;ul[class='note-list']&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> item <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            href <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">&quot;div[class='content'] &gt; a[class='title']&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span>
            title <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">&quot;div[class='content'] &gt; a[class='title']&quot;</span><span class="token punctuation">)</span>
            summary <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">&quot;div[class='content'] &gt; p[class='abstract']&quot;</span><span class="token punctuation">)</span>
            ctx <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">,</span> href<span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">&quot;summary&quot;</span><span class="token punctuation">,</span> summary<span class="token punctuation">)</span>
            <span class="token operator">/</span><span class="token operator">/</span>通过Context上下文对象将采集器<span class="token number">1</span>采集到的数据传递到采集器<span class="token number">2</span>
            c2<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://www.jianshu.com&quot;</span> <span class="token operator">+</span> href<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token operator">/</span><span class="token operator">/</span>采集器<span class="token number">2</span>，获取文章详情
    c2<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        href <span class="token operator">:=</span> e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span>
        title <span class="token operator">:=</span> e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span>
        summary <span class="token operator">:=</span> e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;summary&quot;</span><span class="token punctuation">)</span>
        detail <span class="token operator">:=</span> e<span class="token punctuation">.</span>Text

        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;----------&quot;</span> <span class="token operator">+</span> title <span class="token operator">+</span> <span class="token string">&quot;----------&quot;</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>summary<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c2<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;c2爬取页面：&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c1<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;c1爬取页面：&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c1<span class="token punctuation">.</span><span class="token function">OnError</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Request URL:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">,</span> <span class="token string">&quot;failed with response:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">&quot;\nError:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    err <span class="token operator">:=</span> c1<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.jianshu.com&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    c2<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-爬取需要登录的网页"><a href="#_3-爬取需要登录的网页" class="header-anchor">#</a> 3. 爬取需要登录的网页</h2> <blockquote><p>官网提供登录页处理的例子，但是大多数涉及验证码，不好处理，目前方式是手动登录，复制cookie写到爬虫请求头里</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly/debug&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly/extensions&quot;</span>
    <span class="token boolean">_</span> <span class="token string">&quot;github.com/gocolly/colly/extensions&quot;</span>
    <span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    url <span class="token operator">:=</span> <span class="token string">&quot;https://www.jianshu.com&quot;</span>

    c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>colly<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colly<span class="token punctuation">.</span><span class="token function">MaxDepth</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colly<span class="token punctuation">.</span><span class="token function">Debugger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>debug<span class="token punctuation">.</span>LogDebugger<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;ul[class='note-list']&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> item <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            href <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">&quot;div[class='content'] &gt; a[class='title']&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span>
            title <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">&quot;div[class='content'] &gt; a[class='title']&quot;</span><span class="token punctuation">)</span>
            summary <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">&quot;div[class='content'] &gt; p[class='abstract']&quot;</span><span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> href<span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>summary<span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//设置随机useragent</span>
    extensions<span class="token punctuation">.</span><span class="token function">RandomUserAgent</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token comment">//设置登录cookie</span>
    c<span class="token punctuation">.</span><span class="token function">SetCookies</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">{</span>
        <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">{</span>
            Name<span class="token punctuation">:</span>     <span class="token string">&quot;remember_user_token&quot;</span><span class="token punctuation">,</span>
            Value<span class="token punctuation">:</span>    <span class="token string">&quot;wNDUxOV0sIiQyYSQxMSRwdkhqWVhHYmxXaDJ6dEU3NzJwbmsuIiwiMTU&quot;</span><span class="token punctuation">,</span>
            Path<span class="token punctuation">:</span>     <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
            Domain<span class="token punctuation">:</span>   <span class="token string">&quot;.jianshu.com&quot;</span><span class="token punctuation">,</span>
            Secure<span class="token punctuation">:</span>   <span class="token boolean">true</span><span class="token punctuation">,</span>
            HttpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;爬取页面：&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnError</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Request URL:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">,</span> <span class="token string">&quot;failed with response:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">&quot;\nError:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-内存任务队列"><a href="#_4-内存任务队列" class="header-anchor">#</a> 4. 内存任务队列</h2> <blockquote><p>将需要爬取的连接放入队列中，设置队列并发数，可以并行爬取连接</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly/debug&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly/queue&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>colly<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colly<span class="token punctuation">.</span><span class="token function">MaxDepth</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colly<span class="token punctuation">.</span><span class="token function">Debugger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>debug<span class="token punctuation">.</span>LogDebugger<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//创建内存队列，大小10000，goroutine数量 5</span>
    q<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> queue<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>queue<span class="token punctuation">.</span>InMemoryQueueStorage<span class="token punctuation">{</span>MaxSize<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>element <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;爬取页面：&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnError</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Request URL:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">,</span> <span class="token string">&quot;failed with response:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">&quot;\nError:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    q<span class="token punctuation">.</span><span class="token function">AddURL</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.jianshu.com&quot;</span><span class="token punctuation">)</span>

    q<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-redis任务队列"><a href="#_5-redis任务队列" class="header-anchor">#</a> 5. redis任务队列</h2> <blockquote><p>设置redis存储后，队列中URL存储在redis中，访问页面的cookie及访问记录也会保存在redis中</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly/debug&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly/queue&quot;</span>
    <span class="token string">&quot;github.com/gocolly/redisstorage&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>colly<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colly<span class="token punctuation">.</span><span class="token function">MaxDepth</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colly<span class="token punctuation">.</span><span class="token function">Debugger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>debug<span class="token punctuation">.</span>LogDebugger<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    storage <span class="token operator">:=</span> <span class="token operator">&amp;</span>redisstorage<span class="token punctuation">.</span>Storage<span class="token punctuation">{</span>
        Address<span class="token punctuation">:</span>  <span class="token string">&quot;192.168.1.10:6379&quot;</span><span class="token punctuation">,</span>
        Password<span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span>
        DB<span class="token punctuation">:</span>       <span class="token number">0</span><span class="token punctuation">,</span>
        Prefix<span class="token punctuation">:</span>   <span class="token string">&quot;colly&quot;</span><span class="token punctuation">,</span>
        Client<span class="token punctuation">:</span>   <span class="token boolean">nil</span><span class="token punctuation">,</span>
        Expires<span class="token punctuation">:</span>  <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    c<span class="token punctuation">.</span><span class="token function">SetStorage</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span>

    err <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">defer</span> storage<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    q<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> queue<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> storage<span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>element <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;爬取页面：&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnError</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Request URL:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">,</span> <span class="token string">&quot;failed with response:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">&quot;\nError:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    q<span class="token punctuation">.</span><span class="token function">AddURL</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.jianshu.com&quot;</span><span class="token punctuation">)</span>

    q<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https:////upload-images.jianshu.io/upload_images/15604519-7bd4f8220808532c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/442/format/webp" alt="img"></p> <p>redis中数据</p> <h2 id="_6-配置代理"><a href="#_6-配置代理" class="header-anchor">#</a> 6.配置代理</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;bytes&quot;</span>
    <span class="token string">&quot;log&quot;</span>

    <span class="token string">&quot;github.com/gocolly/colly&quot;</span>
    <span class="token string">&quot;github.com/gocolly/colly/proxy&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//配置两个代理</span>
    rp<span class="token punctuation">,</span> err <span class="token operator">:=</span> proxy<span class="token punctuation">.</span><span class="token function">RoundRobinProxySwitcher</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:1080&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;socks5://127.0.0.1:1338&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span><span class="token function">SetProxyFunc</span><span class="token punctuation">(</span>rp<span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">OnResponse</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">&quot;https://httpbin.org/ip&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>作者：写个代码容易么
链接：https://www.jianshu.com/p/24151de59175
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p> <h1 id="colly-相关文章"><a href="#colly-相关文章" class="header-anchor">#</a> colly 相关文章</h1> <ul><li><a href="https://blog.csdn.net/G_LiQing/article/details/92661989" target="_blank" rel="noopener noreferrer">一个爬取房天下的例子<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li></li></ul> <h1 id="go爬虫框架colly源码以及软件架构分析"><a href="#go爬虫框架colly源码以及软件架构分析" class="header-anchor">#</a> go爬虫框架colly源码以及软件架构分析</h1> <p>无意中发现了<code>colly</code>,我一直是使用python进行爬虫的， 学习golang的使用， 用<code>go</code>参考<code>scrapy</code>架构写了一个爬虫的框架demo。我一直以为go不适合做爬虫， go的领域是后端服务。然后去搜索了一下<code>colly</code>, 发现还是很流行。 我个人还是比较喜欢爬虫， 网络上的数据就是公开的API， 所以， 爬虫去请求接口获取数据。当然我是遵循君子协议的。</p> <p>好， 下面进入正题，介绍<code>colly</code></p> <h3 id="colly介绍"><a href="#colly介绍" class="header-anchor">#</a> colly介绍</h3> <div class="language- extra-class"><pre class="language-text"><code>Lightning Fast and Elegant Scraping Framework for Gophers
</code></pre></div><p><code>Colly provides a clean interface to write any kind of crawler/scraper/spider.</code>
官方的介绍，gocolly快速优雅，在单核上每秒可以发起1K以上请求；以回调函数的形式提供了一组接口，可以实现任意类型的爬虫；依赖goquery库可以像jquery一样选择web元素。</p> <h3 id="安装使用"><a href="#安装使用" class="header-anchor">#</a> 安装使用</h3> <p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fgocolly%2Fcolly" target="_blank" rel="noopener noreferrer">colly<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://links.jianshu.com/go?to=http%3A%2F%2Fgo-colly.org%2F" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>go <span class="token keyword">get</span> <span class="token operator">-</span>u github<span class="token punctuation">.</span>com<span class="token operator">/</span>gocolly<span class="token operator">/</span>colly<span class="token operator">/</span><span class="token range operator">..</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;github.com/gocolly/colly&quot;</span>
</code></pre></div><h3 id="架构特点"><a href="#架构特点" class="header-anchor">#</a> 架构特点</h3> <p>了解爬虫的都知道一个爬虫请求的生命周期</p> <blockquote><ol><li>构建请求</li> <li>发送请求</li> <li>获取文档或数据</li> <li>解析文档或清洗数据</li> <li>数据处理或持久化</li></ol></blockquote> <p>scrapy的设计理念是将上面的每一个步骤抽离出来，然后做出组件的形式， 最后通过调度组成流水线的工作形式。
我们看一下scrapy的架构图， 这里只是简单的介绍下， 后面有时间，我深入介绍scrapy</p> <p><img src="https:////upload-images.jianshu.io/upload_images/1293367-758075d1a9ac3a80.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/550/format/webp" alt="img"></p> <p>如图，<code>downloader</code>负责请求获取页面，<code>spiders</code>中写具体解析文档的逻辑，<code>item PipeLine</code>数据最后处理， 中间有一些中间件，可以一些功能的装饰。比如，代理，请求频率等。</p> <p>我们介绍一下colly的架构特点
colly的逻辑更像是面向过程编程的， colly的逻辑就是按上面生命周期的顺序管道处理， 只是在不同阶段，加上回调函数进行过滤的时候进行处理。</p> <p><img src="https:////upload-images.jianshu.io/upload_images/1293367-b3ea62d1015a0f84.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p> <p>下面也按照这个逻辑进行介绍</p> <h3 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h3> <p>先给一个🌰</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>

    <span class="token string">&quot;github.com/gocolly/colly&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Instantiate default collector</span>
    c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
        <span class="token comment">// Visit only domains: hackerspaces.org, wiki.hackerspaces.org</span>
        colly<span class="token punctuation">.</span><span class="token function">AllowedDomains</span><span class="token punctuation">(</span><span class="token string">&quot;hackerspaces.org&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wiki.hackerspaces.org&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// On every a element which has href attribute call callback</span>
    c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;a[href]&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        link <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">// Print link</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Link found: %q -&gt; %s\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Text<span class="token punctuation">,</span> link<span class="token punctuation">)</span>
        <span class="token comment">// Visit link found on page</span>
        <span class="token comment">// Only those links are visited which are in AllowedDomains</span>
        c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">AbsoluteURL</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// Before making a request print &quot;Visiting ...&quot;</span>
    c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Visiting&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// Start scraping on https://hackerspaces.org</span>
    c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">&quot;https://hackerspaces.org/&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这是官方给的示例， 可以看到<code>colly.NewCollector</code>创建一个<code>收集器</code>， colly的所有处理逻辑都是以<code>Collector</code>为核心进行操作的。</p> <p>我们看一下 <code>Collector</code>结构体的定义</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Collector provides the scraper instance for a scraping job</span>
<span class="token keyword">type</span> Collector <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// UserAgent is the User-Agent string used by HTTP requests</span>
    UserAgent <span class="token builtin">string</span>
    <span class="token comment">// MaxDepth limits the recursion depth of visited URLs.</span>
    <span class="token comment">// Set it to 0 for infinite recursion (default).</span>
    MaxDepth <span class="token builtin">int</span>
    <span class="token comment">// AllowedDomains is a domain whitelist.</span>
    <span class="token comment">// Leave it blank to allow any domains to be visited</span>
    AllowedDomains <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token comment">// DisallowedDomains is a domain blacklist.</span>
    DisallowedDomains <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token comment">// DisallowedURLFilters is a list of regular expressions which restricts</span>
    <span class="token comment">// visiting URLs. If any of the rules matches to a URL the</span>
    <span class="token comment">// request will be stopped. DisallowedURLFilters will</span>
    <span class="token comment">// be evaluated before URLFilters</span>
    <span class="token comment">// Leave it blank to allow any URLs to be visited</span>
    DisallowedURLFilters <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>regexp<span class="token punctuation">.</span>Regexp
    <span class="token comment">// URLFilters is a list of regular expressions which restricts</span>
    <span class="token comment">// visiting URLs. If any of the rules matches to a URL the</span>
    <span class="token comment">// request won't be stopped. DisallowedURLFilters will</span>
    <span class="token comment">// be evaluated before URLFilters</span>

    <span class="token comment">// Leave it blank to allow any URLs to be visited</span>
    URLFilters <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>regexp<span class="token punctuation">.</span>Regexp

    <span class="token comment">// AllowURLRevisit allows multiple downloads of the same URL</span>
    AllowURLRevisit <span class="token builtin">bool</span>
    <span class="token comment">// MaxBodySize is the limit of the retrieved response body in bytes.</span>
    <span class="token comment">// 0 means unlimited.</span>
    <span class="token comment">// The default value for MaxBodySize is 10MB (10 * 1024 * 1024 bytes).</span>
    MaxBodySize <span class="token builtin">int</span>
    <span class="token comment">// CacheDir specifies a location where GET requests are cached as files.</span>
    <span class="token comment">// When it's not defined, caching is disabled.</span>
    CacheDir <span class="token builtin">string</span>
    <span class="token comment">// IgnoreRobotsTxt allows the Collector to ignore any restrictions set by</span>
    <span class="token comment">// the target host's robots.txt file.  See http://www.robotstxt.org/ for more</span>
    <span class="token comment">// information.</span>
    IgnoreRobotsTxt <span class="token builtin">bool</span>
    <span class="token comment">// Async turns on asynchronous network communication. Use Collector.Wait() to</span>
    <span class="token comment">// be sure all requests have been finished.</span>
    Async <span class="token builtin">bool</span>
    <span class="token comment">// ParseHTTPErrorResponse allows parsing HTTP responses with non 2xx status codes.</span>
    <span class="token comment">// By default, Colly parses only successful HTTP responses. Set ParseHTTPErrorResponse</span>
    <span class="token comment">// to true to enable it.</span>
    ParseHTTPErrorResponse <span class="token builtin">bool</span>
    <span class="token comment">// ID is the unique identifier of a collector</span>
    ID <span class="token builtin">uint32</span>
    <span class="token comment">// DetectCharset can enable character encoding detection for non-utf8 response bodies</span>
    <span class="token comment">// without explicit charset declaration. This feature uses https://github.com/saintfish/chardet</span>
    DetectCharset <span class="token builtin">bool</span>
    <span class="token comment">// RedirectHandler allows control on how a redirect will be managed</span>
    RedirectHandler <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> via <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token comment">// CheckHead performs a HEAD request before every GET to pre-validate the response</span>
    CheckHead         <span class="token builtin">bool</span>
    store             storage<span class="token punctuation">.</span>Storage
    debugger          debug<span class="token punctuation">.</span>Debugger
    robotsMap         <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>robotstxt<span class="token punctuation">.</span>RobotsData
    htmlCallbacks     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>htmlCallbackContainer
    xmlCallbacks      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>xmlCallbackContainer
    requestCallbacks  <span class="token punctuation">[</span><span class="token punctuation">]</span>RequestCallback
    responseCallbacks <span class="token punctuation">[</span><span class="token punctuation">]</span>ResponseCallback
    errorCallbacks    <span class="token punctuation">[</span><span class="token punctuation">]</span>ErrorCallback
    scrapedCallbacks  <span class="token punctuation">[</span><span class="token punctuation">]</span>ScrapedCallback
    requestCount      <span class="token builtin">uint32</span>
    responseCount     <span class="token builtin">uint32</span>
    backend           <span class="token operator">*</span>httpBackend
    wg                <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup
    lock              <span class="token operator">*</span>sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">}</span>
</code></pre></div><p>上面的具体属性我就不介绍了， 看看注释也就懂了。
我就先按上面的示例解释源码</p> <div class="language-bash extra-class"><pre class="language-bash"><code>    // 创建一个 Collector对象
    c :<span class="token operator">=</span> colly.NewCollector<span class="token punctuation">(</span>
        // Visit only domains: hackerspaces.org, wiki.hackerspaces.org
        colly.AllowedDomains<span class="token punctuation">(</span><span class="token string">&quot;hackerspaces.org&quot;</span>, <span class="token string">&quot;wiki.hackerspaces.org&quot;</span><span class="token punctuation">)</span>,
    <span class="token punctuation">)</span>

    // 添加一个HTML的回调函数
    c.OnHTML<span class="token punctuation">(</span><span class="token string">&quot;a[href]&quot;</span>, func<span class="token punctuation">(</span>e *colly.HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">link</span> :<span class="token operator">=</span> e.Attr<span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span>
        // Print <span class="token function">link</span>
        fmt.Printf<span class="token punctuation">(</span><span class="token string">&quot;Link found: %q -&gt; %s<span class="token entity" title="\n">\n</span>&quot;</span>, e.Text, <span class="token function">link</span><span class="token punctuation">)</span>
        // Visit <span class="token function">link</span> found on page
        // Only those links are visited <span class="token function">which</span> are <span class="token keyword">in</span> AllowedDomains
        c.Visit<span class="token punctuation">(</span>e.Request.AbsoluteURL<span class="token punctuation">(</span>link<span class="token punctuation">))</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    // 添加一个 Requset回调函数
    c.OnRequest<span class="token punctuation">(</span>func<span class="token punctuation">(</span>r *colly.Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt.Println<span class="token punctuation">(</span><span class="token string">&quot;Visiting&quot;</span>, r.URL.String<span class="token punctuation">(</span><span class="token punctuation">))</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    // 开始爬取
    c.Visit<span class="token punctuation">(</span><span class="token string">&quot;https://hackerspaces.org/&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>回调函数如何用？ 什么作用？ 先卖个关子， <code>c.Visit(&quot;https://hackerspaces.org/&quot;)</code>是入口， 那就先分析它，</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Visit starts Collector's collecting job by creating a</span>
<span class="token comment">// request to the URL specified in parameter.</span>
<span class="token comment">// Visit also calls the previously provided callbacks</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>URL <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>CheckHead <span class="token punctuation">{</span>
        <span class="token keyword">if</span> check <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">scrape</span><span class="token punctuation">(</span>URL<span class="token punctuation">,</span> <span class="token string">&quot;HEAD&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> check <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> check
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">scrape</span><span class="token punctuation">(</span>URL<span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>👆又出来一个新的method，</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">scrape</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> depth <span class="token builtin">int</span><span class="token punctuation">,</span> requestData io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> ctx <span class="token operator">*</span>Context<span class="token punctuation">,</span> hdr http<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> checkRevisit <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查请求是否合法</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">requestCheck</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> checkRevisit<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token comment">// 解析url，</span>
    parsedURL<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> parsedURL<span class="token punctuation">.</span>Scheme <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
        parsedURL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> <span class="token string">&quot;http&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">isDomainAllowed</span><span class="token punctuation">(</span>parsedURL<span class="token punctuation">.</span><span class="token function">Hostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ErrForbiddenDomain
    <span class="token punctuation">}</span>
    <span class="token comment">// robots协议</span>
    <span class="token keyword">if</span> method <span class="token operator">!=</span> <span class="token string">&quot;HEAD&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>IgnoreRobotsTxt <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">checkRobots</span><span class="token punctuation">(</span>parsedURL<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
     <span class="token comment">// headers</span>
    <span class="token keyword">if</span> hdr <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        hdr <span class="token operator">=</span> http<span class="token punctuation">.</span>Header<span class="token punctuation">{</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>UserAgent<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    rc<span class="token punctuation">,</span> ok <span class="token operator">:=</span> requestData<span class="token punctuation">.</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>ReadCloser<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> requestData <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        rc <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>requestData<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// The Go HTTP API ignores &quot;Host&quot; in the headers, preferring the client</span>
    <span class="token comment">// to use the Host field on Request.</span>
    host <span class="token operator">:=</span> parsedURL<span class="token punctuation">.</span>Host
    <span class="token keyword">if</span> hostHeader <span class="token operator">:=</span> hdr<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Host&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> hostHeader <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
        host <span class="token operator">=</span> hostHeader
    <span class="token punctuation">}</span>
    <span class="token comment">// 构造http.Request</span>
    req <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">{</span>
        Method<span class="token punctuation">:</span>     method<span class="token punctuation">,</span>
        URL<span class="token punctuation">:</span>        parsedURL<span class="token punctuation">,</span>
        Proto<span class="token punctuation">:</span>      <span class="token string">&quot;HTTP/1.1&quot;</span><span class="token punctuation">,</span>
        ProtoMajor<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        ProtoMinor<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        Header<span class="token punctuation">:</span>     hdr<span class="token punctuation">,</span>
        Body<span class="token punctuation">:</span>       rc<span class="token punctuation">,</span>
        Host<span class="token punctuation">:</span>       host<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 请求的数据（requestData）转换成io.ReadCloser接口数据</span>
    <span class="token function">setRequestBody</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> requestData<span class="token punctuation">)</span>
    u <span class="token operator">=</span> parsedURL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 异步方式</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Async <span class="token punctuation">{</span>
        <span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> requestData<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> hdr<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> requestData<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> hdr<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面很大篇幅都是检查， 现在还在 <code>request</code>的阶段， 还没有response，看<code>c.fetch</code></p> <p>fetch就是colly的核心内容</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">fetch</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> depth <span class="token builtin">int</span><span class="token punctuation">,</span> requestData io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> ctx <span class="token operator">*</span>Context<span class="token punctuation">,</span> hdr http<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ctx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        ctx <span class="token operator">=</span> <span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    request <span class="token operator">:=</span> <span class="token operator">&amp;</span>Request<span class="token punctuation">{</span>
        URL<span class="token punctuation">:</span>       req<span class="token punctuation">.</span>URL<span class="token punctuation">,</span>
        Headers<span class="token punctuation">:</span>   <span class="token operator">&amp;</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">,</span>
        Ctx<span class="token punctuation">:</span>       ctx<span class="token punctuation">,</span>
        Depth<span class="token punctuation">:</span>     depth<span class="token punctuation">,</span>
        Method<span class="token punctuation">:</span>    method<span class="token punctuation">,</span>
        Body<span class="token punctuation">:</span>      requestData<span class="token punctuation">,</span>
        collector<span class="token punctuation">:</span> c<span class="token punctuation">,</span> <span class="token comment">// 这里将Collector放到request中，这个可以对请求继续处理</span>
        ID<span class="token punctuation">:</span>        atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>requestCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 回调函数处理 request</span>
    c<span class="token punctuation">.</span><span class="token function">handleOnRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

    <span class="token keyword">if</span> request<span class="token punctuation">.</span>abort <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">&quot;POST&quot;</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/x-www-form-urlencoded&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*/*&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    origURL <span class="token operator">:=</span> req<span class="token punctuation">.</span>URL
    <span class="token comment">// 这里是 去请求网络， 是调用了 `http.Client.Do`方法请求的</span>
    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>backend<span class="token punctuation">.</span><span class="token function">Cache</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxBodySize<span class="token punctuation">,</span> c<span class="token punctuation">.</span>CacheDir<span class="token punctuation">)</span>
    <span class="token keyword">if</span> proxyURL<span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>ProxyURLKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span>ProxyURL <span class="token operator">=</span> proxyURL
    <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">/</span> 回调函数，处理<span class="token builtin">error</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">handleOnError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> err<span class="token punctuation">,</span> request<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> req<span class="token punctuation">.</span>URL <span class="token operator">!=</span> origURL <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span>URL <span class="token operator">=</span> req<span class="token punctuation">.</span>URL
        request<span class="token punctuation">.</span>Headers <span class="token operator">=</span> <span class="token operator">&amp;</span>req<span class="token punctuation">.</span>Header
    <span class="token punctuation">}</span>
    atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>responseCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>Ctx <span class="token operator">=</span> ctx
    response<span class="token punctuation">.</span>Request <span class="token operator">=</span> request

    err <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">fixCharset</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>DetectCharset<span class="token punctuation">,</span> request<span class="token punctuation">.</span>ResponseCharacterEncoding<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">/</span> 回调函数 处理Response
    c<span class="token punctuation">.</span><span class="token function">handleOnResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    
    <span class="token operator">/</span><span class="token operator">/</span> 回调函数 HTML
    err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">handleOnHTML</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">handleOnError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> err<span class="token punctuation">,</span> request<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">/</span> 回调函数XML
    err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">handleOnXML</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">handleOnError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> err<span class="token punctuation">,</span> request<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">/</span> 回调函数 Scraped
    c<span class="token punctuation">.</span><span class="token function">handleOnScraped</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre></div><p>看到了， 这就是一个完整的流程。 好， 我们看一下回调函数做了什么？</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
            <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>requestCallbacks <span class="token punctuation">{</span>
        <span class="token function">f</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>核心就 <code>for _, f := range c.requestCallbacks { f(r) }</code>这句，下面我每个回调函数都介绍一下</p> <h3 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h3> <p>这里介绍按生命周期的顺序来介绍</p> <h4 id="_1-onrequest"><a href="#_1-onrequest" class="header-anchor">#</a> 1. OnRequest</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// OnRequest registers a function. Function will be executed on every</span>
<span class="token comment">// request made by the Collector</span>
<span class="token comment">// 这里是注册回调函数到 requestCallbacks</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnRequest</span><span class="token punctuation">(</span>f RequestCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>requestCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
       c<span class="token punctuation">.</span>requestCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>RequestCallback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   c<span class="token punctuation">.</span>requestCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>requestCallbacks<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
   c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment">// 在fetch中调用最早调用的</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
       c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
           <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>requestCallbacks <span class="token punctuation">{</span>
       <span class="token function">f</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-onresponse-handleonresponse"><a href="#_2-onresponse-handleonresponse" class="header-anchor">#</a> 2. OnResponse &amp; handleOnResponse</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// OnResponse registers a function. Function will be executed on every response</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnResponse</span><span class="token punctuation">(</span>f ResponseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>responseCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>responseCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ResponseCallback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span>responseCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>responseCallbacks<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnResponse</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
            <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>responseCallbacks <span class="token punctuation">{</span>
        <span class="token function">f</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-onhtml-handleonhtml"><a href="#_3-onhtml-handleonhtml" class="header-anchor">#</a> 3. OnHTML &amp; handleOnHTML</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// OnHTML registers a function. Function will be executed on every HTML</span>
<span class="token comment">// element matched by the GoQuery Selector parameter.</span>
<span class="token comment">// GoQuery Selector is a selector used by https://github.com/PuerkitoBio/goquery</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnHTML</span><span class="token punctuation">(</span>goquerySelector <span class="token builtin">string</span><span class="token punctuation">,</span> f HTMLCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>htmlCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>htmlCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>htmlCallbackContainer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span>htmlCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>htmlCallbacks<span class="token punctuation">,</span> <span class="token operator">&amp;</span>htmlCallbackContainer<span class="token punctuation">{</span>
        Selector<span class="token punctuation">:</span> goquerySelector<span class="token punctuation">,</span>
        Function<span class="token punctuation">:</span> f<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这个解析html的逻辑比较多一些</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnHTML</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>htmlCallbacks<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> goquery<span class="token punctuation">.</span><span class="token function">NewDocumentFromReader</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> href<span class="token punctuation">,</span> found <span class="token operator">:=</span> doc<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token string">&quot;base[href]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>
        resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>baseURL<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> cc <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>htmlCallbacks <span class="token punctuation">{</span>
        i <span class="token operator">:=</span> <span class="token number">0</span>
        doc<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Each</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token boolean">_</span> <span class="token builtin">int</span><span class="token punctuation">,</span> s <span class="token operator">*</span>goquery<span class="token punctuation">.</span>Selection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>Nodes <span class="token punctuation">{</span>
                e <span class="token operator">:=</span> <span class="token function">NewHTMLElementFromSelectionNode</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> s<span class="token punctuation">,</span> n<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
                i<span class="token operator">++</span>
                <span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
                        <span class="token string">&quot;selector&quot;</span><span class="token punctuation">:</span> cc<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span>
                        <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span>      resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                cc<span class="token punctuation">.</span><span class="token function">Function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-onxml-handleonxml"><a href="#_4-onxml-handleonxml" class="header-anchor">#</a> 4. OnXML &amp; handleOnXML</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// OnXML registers a function. Function will be executed on every XML</span>
<span class="token comment">// element matched by the xpath Query parameter.</span>
<span class="token comment">// xpath Query is used by https://github.com/antchfx/xmlquery</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnXML</span><span class="token punctuation">(</span>xpathQuery <span class="token builtin">string</span><span class="token punctuation">,</span> f XMLCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>xmlCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>xmlCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>xmlCallbackContainer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span>xmlCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>xmlCallbacks<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xmlCallbackContainer<span class="token punctuation">{</span>
        Query<span class="token punctuation">:</span>    xpathQuery<span class="token punctuation">,</span>
        Function<span class="token punctuation">:</span> f<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>



<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnXML</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>xmlCallbacks<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    contentType <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    isXMLFile <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;.xml&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;.xml.gz&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token string">&quot;xml&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isXMLFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> htmlquery<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> e <span class="token operator">:=</span> htmlquery<span class="token punctuation">.</span><span class="token function">FindOne</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token string">&quot;//base&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> e<span class="token punctuation">.</span>Attr <span class="token punctuation">{</span>
                <span class="token keyword">if</span> a<span class="token punctuation">.</span>Key <span class="token operator">==</span> <span class="token string">&quot;href&quot;</span> <span class="token punctuation">{</span>
                    resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>baseURL<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Val<span class="token punctuation">)</span>
                    <span class="token keyword">break</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> cc <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>xmlCallbacks <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> htmlquery<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> cc<span class="token punctuation">.</span>Query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e <span class="token operator">:=</span> <span class="token function">NewXMLElementFromHTMLNode</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
                <span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">&quot;xml&quot;</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
                        <span class="token string">&quot;selector&quot;</span><span class="token punctuation">:</span> cc<span class="token punctuation">.</span>Query<span class="token punctuation">,</span>
                        <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span>      resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                cc<span class="token punctuation">.</span><span class="token function">Function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token string">&quot;xml&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> isXMLFile <span class="token punctuation">{</span>
        doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> xmlquery<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> cc <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>xmlCallbacks <span class="token punctuation">{</span>
            xmlquery<span class="token punctuation">.</span><span class="token function">FindEach</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> cc<span class="token punctuation">.</span>Query<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> n <span class="token operator">*</span>xmlquery<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e <span class="token operator">:=</span> <span class="token function">NewXMLElementFromXMLNode</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
                <span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">&quot;xml&quot;</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
                        <span class="token string">&quot;selector&quot;</span><span class="token punctuation">:</span> cc<span class="token punctuation">.</span>Query<span class="token punctuation">,</span>
                        <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span>      resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                cc<span class="token punctuation">.</span><span class="token function">Function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-onerror-handleonerror"><a href="#_5-onerror-handleonerror" class="header-anchor">#</a> 5. OnError &amp; handleOnError</h4> <p>这个会多次调用， 如果 <code>err != nil情况下调用比较多</code>， 爬虫异常的情况下，会调用</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// OnError registers a function. Function will be executed if an error</span>
<span class="token comment">// occurs during the HTTP request.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnError</span><span class="token punctuation">(</span>f ErrorCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>errorCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>errorCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ErrorCallback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span>errorCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>errorCallbacks<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnError</span><span class="token punctuation">(</span>response <span class="token operator">*</span>Response<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">,</span> request <span class="token operator">*</span>Request<span class="token punctuation">,</span> ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>ParseHTTPErrorResponse <span class="token operator">||</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">&lt;</span> <span class="token number">203</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">&gt;=</span> <span class="token number">203</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> response <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        response <span class="token operator">=</span> <span class="token operator">&amp;</span>Response<span class="token punctuation">{</span>
            Request<span class="token punctuation">:</span> request<span class="token punctuation">,</span>
            Ctx<span class="token punctuation">:</span>     ctx<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
            <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span>    request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>Request <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span>Request <span class="token operator">=</span> request
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>Ctx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span>Ctx <span class="token operator">=</span> request<span class="token punctuation">.</span>Ctx
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>errorCallbacks <span class="token punctuation">{</span>
        <span class="token function">f</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-onscraped-handleonscraped"><a href="#_6-onscraped-handleonscraped" class="header-anchor">#</a> 6. OnScraped &amp; handleOnScraped</h4> <p>最后一步的回调函数处理</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// OnScraped registers a function. Function will be executed after</span>
<span class="token comment">// OnHTML, as a final part of the scraping.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnScraped</span><span class="token punctuation">(</span>f ScrapedCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>scrapedCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>scrapedCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ScrapedCallback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span>scrapedCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>scrapedCallbacks<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnScraped</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">&quot;scraped&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
            <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>scrapedCallbacks <span class="token punctuation">{</span>
        <span class="token function">f</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注册回调函数的method还有几个没有列出来，感兴趣的，自己看一下，</p> <p>上面介绍完了， 再回头看🌰</p> <div class="language-go extra-class"><pre class="language-go"><code>    <span class="token comment">// On every a element which has href attribute call callback</span>
    c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;a[href]&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        link <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">// Print link</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Link found: %q -&gt; %s\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Text<span class="token punctuation">,</span> link<span class="token punctuation">)</span>
        <span class="token comment">// Visit link found on page</span>
        <span class="token comment">// Only those links are visited which are in AllowedDomains</span>
        c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">AbsoluteURL</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// Before making a request print &quot;Visiting ...&quot;</span>
    c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Visiting&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>一般文档解析放在html, xml 中</p> <h3 id="页面跳转爬取"><a href="#页面跳转爬取" class="header-anchor">#</a> 页面跳转爬取</h3> <p>一般处理就2种，一种是相同逻辑的页面，比如<code>下一页</code>，另一种，就是不同逻辑的，比如<code>子页面</code></p> <ol><li>在<code>html</code>,<code>xml</code>，解析出来以后，构建新的请求，我们看一下，相同页面</li></ol> <div class="language-go extra-class"><pre class="language-go"><code>   <span class="token comment">// On every a element which has href attribute call callback</span>
   c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;a[href]&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// If attribute class is this long string return from callback</span>
       <span class="token comment">// As this a is irrelevant</span>
       <span class="token keyword">if</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;Button_1qxkboh-o_O-primary_cv02ee-o_O-md_28awn8-o_O-primaryLink_109aggg&quot;</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span>
       <span class="token punctuation">}</span>
       link <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span>
       <span class="token comment">// If link start with browse or includes either signup or login return from callback</span>
       <span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">&quot;/browse&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">&quot;=signup&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">&quot;=login&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// start scaping the page under the link found</span>
       e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面是 HTML的回调函数，解析页面，获取了<code>url</code>,使用 <code>e.Request.Visit(link)</code>, 其实就是 <code>e.Request.collector.Visit(link)</code>
我解释一下</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">fetch</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> depth <span class="token builtin">int</span><span class="token punctuation">,</span> requestData io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> ctx <span class="token operator">*</span>Context<span class="token punctuation">,</span> hdr http<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ctx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        ctx <span class="token operator">=</span> <span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    request <span class="token operator">:=</span> <span class="token operator">&amp;</span>Request<span class="token punctuation">{</span>
        URL<span class="token punctuation">:</span>       req<span class="token punctuation">.</span>URL<span class="token punctuation">,</span>
        Headers<span class="token punctuation">:</span>   <span class="token operator">&amp;</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">,</span>
        Ctx<span class="token punctuation">:</span>       ctx<span class="token punctuation">,</span>
        Depth<span class="token punctuation">:</span>     depth<span class="token punctuation">,</span>
        Method<span class="token punctuation">:</span>    method<span class="token punctuation">,</span>
        Body<span class="token punctuation">:</span>      requestData<span class="token punctuation">,</span>
        collector<span class="token punctuation">:</span> c<span class="token punctuation">,</span> <span class="token comment">// 这个上面有介绍</span>
        ID<span class="token punctuation">:</span>        atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>requestCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span>


<span class="token comment">// Visit continues Collector's collecting job by creating a</span>
<span class="token comment">// request and preserves the Context of the previous request.</span>
<span class="token comment">// Visit also calls the previously provided callbacks</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>URL <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> r<span class="token punctuation">.</span>collector<span class="token punctuation">.</span><span class="token function">scrape</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">AbsoluteURL</span><span class="token punctuation">(</span>URL<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Ctx<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这种方法在实际开发中经常会用到。</p> <ol><li>子页面的处理逻辑
colly中主要是以<code>Collector</code>为中心， 然后各种回调函数进行处理，子页面需要不同的回调函数，所以就需要新的 <code>Collector</code></li></ol> <div class="language-go extra-class"><pre class="language-go"><code>    <span class="token comment">// Instantiate default collector</span>
    c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
        <span class="token comment">// Visit only domains: coursera.org, www.coursera.org</span>
        colly<span class="token punctuation">.</span><span class="token function">AllowedDomains</span><span class="token punctuation">(</span><span class="token string">&quot;coursera.org&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;www.coursera.org&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">// Cache responses to prevent multiple download of pages</span>
        <span class="token comment">// even if the collector is restarted</span>
        colly<span class="token punctuation">.</span><span class="token function">CacheDir</span><span class="token punctuation">(</span><span class="token string">&quot;./coursera_cache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// Create another collector to scrape course details</span>
    detailCollector <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Before making a request print &quot;Visiting ...&quot;</span>
    c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;visiting&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// On every a HTML element which has name attribute call callback</span>
    c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">`a[name]`</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Activate detailCollector if the link contains &quot;coursera.org/learn&quot;</span>
        courseURL <span class="token operator">:=</span> e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">AbsoluteURL</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>courseURL<span class="token punctuation">,</span> <span class="token string">&quot;coursera.org/learn&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
           <span class="token comment">// 子页面或其他页面</span>
            detailCollector<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>courseURL<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h3> <p><code>Collector</code>对象有一个属性 <code>store storage.Storage</code>是存储的，这个是将数据直接存储下来，没有清洗。
比如， 我需要将数据持久化到数据库中，其实很简单， 在回调函数中处理。</p> <p>给个例子</p> <div class="language-go extra-class"><pre class="language-go"><code>    c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">&quot;#currencies-all tbody tr&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mysql<span class="token punctuation">.</span><span class="token function">WriteObjectStrings</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">&quot;.currency-name-container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">&quot;.col-symbol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">&quot;a.price&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data-usd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">&quot;a.volume&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data-usd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">&quot;.market-cap&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data-usd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">&quot;.percent-change[data-timespan=\&quot;1h\&quot;]&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data-percentusd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">&quot;.percent-change[data-timespan=\&quot;24h\&quot;]&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data-percentusd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">&quot;.percent-change[data-timespan=\&quot;7d\&quot;]&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data-percentusd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>好了，介绍完了，我没有介绍如何使用，我自己也没有写任何的代码， 我只想分享给你这种软件架构的特点以及设计模式， 希望你可以借鉴应用到工作中，一般写框架都是采用这种思维。
下面这张图很形象，爬虫框架就这些东西。</p> <p><img src="https:////upload-images.jianshu.io/upload_images/1293367-f113911d24db3e9c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/658/format/webp" alt="通用爬虫框架架构"></p> <blockquote><p>作者：若与
链接：https://www.jianshu.com/p/93187b80541f
来源：简书</p></blockquote> <p>不错的 colly 底层解析文章：<a href="https://blog.csdn.net/breaksoftware/article/details/84582416" target="_blank" rel="noopener noreferrer">Colly源码解析——结合例子分析底层实现_方亮的专栏-CSDN博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h1 id="代理的初探索"><a href="#代理的初探索" class="header-anchor">#</a> 代理的初探索</h1> <h2 id="检测-ip"><a href="#检测-ip" class="header-anchor">#</a> 检测 ip</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> https://httpbin.org/ip
<span class="token function">curl</span> cip.cc
</code></pre></div><h1 id="检测代理池"><a href="#检测代理池" class="header-anchor">#</a> 检测代理池</h1> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> ckporxy

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">type</span> Checker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// 是否使用文件存储,如果为 false,则通过方法返回</span>
	IsFileSave <span class="token builtin">bool</span>
	<span class="token comment">// 待检测的文件路径</span>
	ProxyFile <span class="token builtin">string</span>
	<span class="token comment">// 成功的代理存储路径</span>
	PassProxyFile <span class="token builtin">string</span>
	<span class="token comment">// 检测代理用的网址</span>
	CheckUrl <span class="token builtin">string</span>
	<span class="token comment">// 检测超时时间,默认为 10 秒</span>
	CheckTimeout time<span class="token punctuation">.</span>Duration
	<span class="token comment">// 待检测的数据,如果有值,则不读取文件</span>
	ProxyData <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token comment">// 检测通过的数据</span>
	PassProxyData <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// New 创建一个检测模型</span>
<span class="token keyword">func</span> <span class="token function">NewChecker</span><span class="token punctuation">(</span>options <span class="token operator">...</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Checker<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>Checker <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Checker<span class="token punctuation">{</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> options <span class="token punctuation">{</span>
		<span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Checker<span class="token punctuation">)</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>ProxyFile <span class="token operator">=</span> <span class="token string">&quot;./proxy.txt&quot;</span>
	c<span class="token punctuation">.</span>CheckUrl <span class="token operator">=</span> <span class="token string">&quot;http://icanhazip.com&quot;</span>
	c<span class="token punctuation">.</span>PassProxyFile <span class="token operator">=</span> <span class="token string">&quot;./proxy_pass.txt&quot;</span>
	c<span class="token punctuation">.</span>CheckTimeout <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second
	c<span class="token punctuation">.</span>ProxyData <span class="token operator">=</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Checker<span class="token punctuation">)</span> <span class="token function">ProxyThorn</span><span class="token punctuation">(</span>proxyAddr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ip <span class="token builtin">string</span><span class="token punctuation">,</span> status <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//访问查看ip的一个网址</span>

	proxy<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>proxyAddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> proxy<span class="token punctuation">.</span>Scheme <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		proxy<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> <span class="token string">&quot;http&quot;</span>
	<span class="token punctuation">}</span>

	netTransport <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span>
		Proxy<span class="token punctuation">:</span>                 http<span class="token punctuation">.</span><span class="token function">ProxyURL</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">,</span>
		MaxIdleConnsPerHost<span class="token punctuation">:</span>   <span class="token number">10</span><span class="token punctuation">,</span>
		ResponseHeaderTimeout<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	httpClient <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>   c<span class="token punctuation">.</span>CheckTimeout<span class="token punctuation">,</span>
		Transport<span class="token punctuation">:</span> netTransport<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> httpClient<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>CheckUrl<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">//fmt.Println(&quot;错误信息：&quot;,err)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> res<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> res<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">{</span>
		<span class="token comment">//log.Println(&quot;请求失败:&quot;,res.StatusCode)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>StatusCode
<span class="token punctuation">}</span>

<span class="token comment">// 读取待检测的代理</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Checker<span class="token punctuation">)</span> <span class="token function">readProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ProxyFile<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;open ip.txt failed,err:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		line<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token comment">//注意是字符</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;read file failed, err:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		line <span class="token operator">=</span> line<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
		link <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s&quot;</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span>

		data <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> link<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> data

<span class="token punctuation">}</span>

<span class="token comment">// ip验证</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Checker<span class="token punctuation">)</span> <span class="token function">verification</span><span class="token punctuation">(</span>ipInfo <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> ip<span class="token punctuation">,</span> status <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">ProxyThorn</span><span class="token punctuation">(</span>ipInfo<span class="token punctuation">)</span>
	<span class="token keyword">var</span> result <span class="token builtin">string</span>
	<span class="token comment">//判断是否有返回ip，并且请求状态为200</span>
	<span class="token keyword">if</span> status <span class="token operator">==</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> ip <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		<span class="token comment">// 成功的地址写入文件</span>
		c<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>ipInfo<span class="token punctuation">)</span>
		result <span class="token operator">=</span> <span class="token string">&quot;success&quot;</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		result <span class="token operator">=</span> <span class="token string">&quot;fail&quot;</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;代理:%v[检测结果:%s] \n&quot;</span><span class="token punctuation">,</span> ipInfo<span class="token punctuation">,</span> result<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token comment">// Check 检测代理</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Checker<span class="token punctuation">)</span> <span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//使用 goroutine 去检测 代理的可用性</span>
	<span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>ProxyData <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		data <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">readProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		data <span class="token operator">=</span> c<span class="token punctuation">.</span>ProxyData
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ipInfo <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">verification</span><span class="token punctuation">(</span>ipInfo<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 把可用的 ip 写入文件</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Checker<span class="token punctuation">)</span> <span class="token function">writeFile</span><span class="token punctuation">(</span>data <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>PassProxyFile<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_APPEND<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;open file failed,err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="用法"><a href="#用法" class="header-anchor">#</a> 用法</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  data <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;http://14.97.2.106:80&quot;</span><span class="token operator">...</span><span class="token punctuation">}</span>
	data <span class="token operator">=</span> data

	c <span class="token operator">:=</span> ckproxy<span class="token punctuation">.</span><span class="token function">NewChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span>CheckTimeout <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second
  <span class="token comment">// 传入数据</span>
	c<span class="token punctuation">.</span>ProxyData <span class="token operator">=</span> data
  <span class="token comment">//or 使用文件</span>
  <span class="token comment">//c.ProxyFile = &quot;./ip.txt&quot;</span>

	c<span class="token punctuation">.</span><span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="待采集的免费代理-ip-源"><a href="#待采集的免费代理-ip-源" class="header-anchor">#</a> 待采集的免费代理 ip 源</h2> <ul><li><a href="https://www.7yip.cn/free/?action=china&amp;page=1" target="_blank" rel="noopener noreferrer">免费代理ip - 齐云代理 - 专业http代理ip供应平台每天更新大量免费代理IP资源 (7yip.cn)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://ip.ihuan.me/" target="_blank" rel="noopener noreferrer">小幻HTTP代理 - 提供比收费还强大的免费HTTP代理IP (ihuan.me)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.kuaidaili.com/free/" target="_blank" rel="noopener noreferrer">国内高匿免费HTTP代理IP - 快代理 (kuaidaili.com)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.zdaye.com/FreeIPList.html" target="_blank" rel="noopener noreferrer">免费代理IP - 站大爷 - 企业级高品质Http代理IP/Socks5代理IP供应平台/免费代理IP (zdaye.com)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/super-eggs/vuepress-blog/edit/master/docs/Go_Practice/README.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Go_Practice/Cobra.html" class="prev">
        golang命令行库Cobra的使用
      </a></span> <span class="next"><a href="/Go_Practice/Singo.html">
        Singo 使用手册
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div class="reading-progress top" data-v-21b39eda><div class="progress" data-v-21b39eda></div></div></div></div>
    <script src="/assets/js/app.693e6c19.js" defer></script><script src="/assets/js/2.3304c2e1.js" defer></script><script src="/assets/js/31.a273a940.js" defer></script>
  </body>
</html>
