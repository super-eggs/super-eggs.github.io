<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>go 入门教程 | SuperEggs</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="shortcut icon" href="/log.ico" type="image/jpg">
    <script>
            var _hmt = _hmt || [];
            (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    <script src="/js/jquery-3.5.min.js"></script>
    <script src="/js/cursor.min.js"></script>
    <meta name="description" content="分享生活高效技能,保持勇敢，坚持有趣，生命不息，折腾不止！">
    <meta property="og:site_name" content="SuperEggs">
    <meta property="og:title" content="go 入门教程">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/Go/">
    <meta name="twitter:title" content="go 入门教程">
    <meta name="twitter:url" content="/Go/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="keywords" content="html,css,jquery,thinkphp,laravel,docker,linux,manjaro">
    <meta name="auther" content="SuperEggs">
    <link rel="preload" href="/assets/css/0.styles.5f689f29.css" as="style"><link rel="preload" href="/assets/js/app.693e6c19.js" as="script"><link rel="preload" href="/assets/js/2.3304c2e1.js" as="script"><link rel="preload" href="/assets/js/24.124a82a4.js" as="script"><link rel="prefetch" href="/assets/js/10.34123518.js"><link rel="prefetch" href="/assets/js/11.f0e24eb8.js"><link rel="prefetch" href="/assets/js/12.5e75a974.js"><link rel="prefetch" href="/assets/js/13.db0bf381.js"><link rel="prefetch" href="/assets/js/14.ed324319.js"><link rel="prefetch" href="/assets/js/15.f40e8254.js"><link rel="prefetch" href="/assets/js/16.d8f963c5.js"><link rel="prefetch" href="/assets/js/17.250470cc.js"><link rel="prefetch" href="/assets/js/18.5161c52b.js"><link rel="prefetch" href="/assets/js/19.afb8dd7a.js"><link rel="prefetch" href="/assets/js/20.c8248808.js"><link rel="prefetch" href="/assets/js/21.e818d83d.js"><link rel="prefetch" href="/assets/js/22.69d0a99c.js"><link rel="prefetch" href="/assets/js/23.92b9837f.js"><link rel="prefetch" href="/assets/js/25.1c0271e6.js"><link rel="prefetch" href="/assets/js/26.34e44644.js"><link rel="prefetch" href="/assets/js/27.4f89b112.js"><link rel="prefetch" href="/assets/js/28.82ed427e.js"><link rel="prefetch" href="/assets/js/29.64fae044.js"><link rel="prefetch" href="/assets/js/3.1c0cc69b.js"><link rel="prefetch" href="/assets/js/30.dc7d1b9b.js"><link rel="prefetch" href="/assets/js/31.a273a940.js"><link rel="prefetch" href="/assets/js/32.ca99c448.js"><link rel="prefetch" href="/assets/js/33.4129d67d.js"><link rel="prefetch" href="/assets/js/34.a49e24e6.js"><link rel="prefetch" href="/assets/js/35.4ba458c0.js"><link rel="prefetch" href="/assets/js/36.7412ff8c.js"><link rel="prefetch" href="/assets/js/37.35c3a72c.js"><link rel="prefetch" href="/assets/js/38.ebf390fb.js"><link rel="prefetch" href="/assets/js/39.6b308832.js"><link rel="prefetch" href="/assets/js/4.e5a930e9.js"><link rel="prefetch" href="/assets/js/40.968d571d.js"><link rel="prefetch" href="/assets/js/41.a1f587bf.js"><link rel="prefetch" href="/assets/js/42.9f358bc3.js"><link rel="prefetch" href="/assets/js/43.4f19f41e.js"><link rel="prefetch" href="/assets/js/44.a27ad98a.js"><link rel="prefetch" href="/assets/js/45.fb26a2d8.js"><link rel="prefetch" href="/assets/js/46.aa66c6d7.js"><link rel="prefetch" href="/assets/js/47.00ae1556.js"><link rel="prefetch" href="/assets/js/48.699e8e33.js"><link rel="prefetch" href="/assets/js/49.0f79ef04.js"><link rel="prefetch" href="/assets/js/5.2d78753d.js"><link rel="prefetch" href="/assets/js/50.2428dcc2.js"><link rel="prefetch" href="/assets/js/51.829dcccc.js"><link rel="prefetch" href="/assets/js/52.f2dfda6b.js"><link rel="prefetch" href="/assets/js/53.225de2db.js"><link rel="prefetch" href="/assets/js/54.b91ed453.js"><link rel="prefetch" href="/assets/js/55.25bacde7.js"><link rel="prefetch" href="/assets/js/56.2a58cece.js"><link rel="prefetch" href="/assets/js/57.48eab866.js"><link rel="prefetch" href="/assets/js/58.5cf8ca6e.js"><link rel="prefetch" href="/assets/js/59.458178cc.js"><link rel="prefetch" href="/assets/js/6.66329e4b.js"><link rel="prefetch" href="/assets/js/60.7898b9b9.js"><link rel="prefetch" href="/assets/js/61.5f651468.js"><link rel="prefetch" href="/assets/js/62.cd190cb0.js"><link rel="prefetch" href="/assets/js/63.0d472232.js"><link rel="prefetch" href="/assets/js/64.e8a8ffe7.js"><link rel="prefetch" href="/assets/js/65.8a66ff7d.js"><link rel="prefetch" href="/assets/js/66.0492741b.js"><link rel="prefetch" href="/assets/js/67.204dadcb.js"><link rel="prefetch" href="/assets/js/68.7d5b0a8f.js"><link rel="prefetch" href="/assets/js/69.ed735059.js"><link rel="prefetch" href="/assets/js/7.44229983.js"><link rel="prefetch" href="/assets/js/70.0f643f0b.js"><link rel="prefetch" href="/assets/js/71.a226be62.js"><link rel="prefetch" href="/assets/js/8.51a4d2f9.js"><link rel="prefetch" href="/assets/js/9.ee30d1ab.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5f689f29.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/log.png" alt="SuperEggs" class="logo"> <span class="site-name can-hide">SuperEggs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具软件" class="dropdown-title"><span class="title">工具软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具软件" class="mobile-dropdown-title"><span class="title">工具软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Tool/windows.html" class="nav-link">
  Windows
</a></li><li class="dropdown-item"><!----> <a href="/Tool/01brew.html" class="nav-link">
  Brew
</a></li><li class="dropdown-item"><!----> <a href="/Tool/02yarn.html" class="nav-link">
  Yarn
</a></li><li class="dropdown-item"><!----> <a href="/Tool/git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/Tool/goland.html" class="nav-link">
  Goland
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="go" class="dropdown-title"><span class="title">go</span> <span class="arrow down"></span></button> <button type="button" aria-label="go" class="mobile-dropdown-title"><span class="title">go</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Go/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  go Wiki
</a></li><li class="dropdown-item"><!----> <a href="/Go_Practice/" class="nav-link">
  go 实践
</a></li><li class="dropdown-item"><!----> <a href="/Go_Packages/" class="nav-link">
  go 包
</a></li></ul></div></div><div class="nav-item"><a href="/Laravel/" class="nav-link">
  Laravel
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发环境" class="dropdown-title"><span class="title">开发环境</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发环境" class="mobile-dropdown-title"><span class="title">开发环境</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Wamp/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/Linux/Config.html" class="nav-link">
  配置文件
</a></li><li class="dropdown-item"><!----> <a href="/Linux/Tool.html" class="nav-link">
  生产工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Code" class="dropdown-title"><span class="title">Code</span> <span class="arrow down"></span></button> <button type="button" aria-label="Code" class="mobile-dropdown-title"><span class="title">Code</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Html
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Code/Css.html" class="nav-link">
  Css样式收藏
</a></li><li class="dropdown-subitem"><a href="/Code/Layui.html" class="nav-link">
  Layui笔记
</a></li><li class="dropdown-subitem"><a href="/Code/Javascript.html" class="nav-link">
  Javascript手册
</a></li><li class="dropdown-subitem"><a href="/Code/Menu.html" class="nav-link">
  在线手册
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/Code/VueNote.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><h4>
          Php
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Code/Php.html" class="nav-link">
  Php使用技巧
</a></li><li class="dropdown-subitem"><a href="/Code/Thinkphp.html" class="nav-link">
  ThinkPhp
</a></li><li class="dropdown-subitem"><a href="/Code/LaraCode.html" class="nav-link">
  LaraCode
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/MyNote/" class="nav-link">
  MyNote
</a></div><div class="nav-item"><a href="/WebNote/" class="nav-link">
  WebNote
</a></div><div class="nav-item"><a href="/EMS/" class="nav-link">
  EMS
</a></div> <a href="https://github.com/super-eggs/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具软件" class="dropdown-title"><span class="title">工具软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具软件" class="mobile-dropdown-title"><span class="title">工具软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Tool/windows.html" class="nav-link">
  Windows
</a></li><li class="dropdown-item"><!----> <a href="/Tool/01brew.html" class="nav-link">
  Brew
</a></li><li class="dropdown-item"><!----> <a href="/Tool/02yarn.html" class="nav-link">
  Yarn
</a></li><li class="dropdown-item"><!----> <a href="/Tool/git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/Tool/goland.html" class="nav-link">
  Goland
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="go" class="dropdown-title"><span class="title">go</span> <span class="arrow down"></span></button> <button type="button" aria-label="go" class="mobile-dropdown-title"><span class="title">go</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Go/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  go Wiki
</a></li><li class="dropdown-item"><!----> <a href="/Go_Practice/" class="nav-link">
  go 实践
</a></li><li class="dropdown-item"><!----> <a href="/Go_Packages/" class="nav-link">
  go 包
</a></li></ul></div></div><div class="nav-item"><a href="/Laravel/" class="nav-link">
  Laravel
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发环境" class="dropdown-title"><span class="title">开发环境</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发环境" class="mobile-dropdown-title"><span class="title">开发环境</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Wamp/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/Linux/Config.html" class="nav-link">
  配置文件
</a></li><li class="dropdown-item"><!----> <a href="/Linux/Tool.html" class="nav-link">
  生产工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Code" class="dropdown-title"><span class="title">Code</span> <span class="arrow down"></span></button> <button type="button" aria-label="Code" class="mobile-dropdown-title"><span class="title">Code</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Html
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Code/Css.html" class="nav-link">
  Css样式收藏
</a></li><li class="dropdown-subitem"><a href="/Code/Layui.html" class="nav-link">
  Layui笔记
</a></li><li class="dropdown-subitem"><a href="/Code/Javascript.html" class="nav-link">
  Javascript手册
</a></li><li class="dropdown-subitem"><a href="/Code/Menu.html" class="nav-link">
  在线手册
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/Code/VueNote.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><h4>
          Php
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Code/Php.html" class="nav-link">
  Php使用技巧
</a></li><li class="dropdown-subitem"><a href="/Code/Thinkphp.html" class="nav-link">
  ThinkPhp
</a></li><li class="dropdown-subitem"><a href="/Code/LaraCode.html" class="nav-link">
  LaraCode
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/MyNote/" class="nav-link">
  MyNote
</a></div><div class="nav-item"><a href="/WebNote/" class="nav-link">
  WebNote
</a></div><div class="nav-item"><a href="/EMS/" class="nav-link">
  EMS
</a></div> <a href="https://github.com/super-eggs/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Go</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Go/" aria-current="page" class="active sidebar-link">go 入门教程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Go/#go-入门教程" class="sidebar-link">go 入门教程</a></li><li class="sidebar-sub-header"><a href="/Go/#go-module" class="sidebar-link">Go Module</a></li><li class="sidebar-sub-header"><a href="/Go/#_1-golang-gc-发展" class="sidebar-link">1. Golang GC 发展</a></li><li class="sidebar-sub-header"><a href="/Go/#_2-gc-算法简介" class="sidebar-link">2. GC 算法简介</a></li><li class="sidebar-sub-header"><a href="/Go/#_3-golang-gc" class="sidebar-link">3. Golang GC</a></li><li class="sidebar-sub-header"><a href="/Go/#_4-参考资料" class="sidebar-link">4.参考资料</a></li></ul></li><li><a href="/Go/mianshiti.html" class="sidebar-link">go 面试题练习</a></li><li><a href="/Go/post.html" class="sidebar-link">append() 并发安全问题</a></li><li><a href="/Go/《go 语言实战》 读书笔记.html" class="sidebar-link">《go 语言实战》 读书笔记</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="go-入门教程"><a href="#go-入门教程" class="header-anchor">#</a> go 入门教程</h2> <ul><li><p><a href="http://tour.studygolang.com/list" target="_blank" rel="noopener noreferrer">Go 语言之旅 (studygolang.com)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="http://books.studygolang.com/gobyexample/" target="_blank" rel="noopener noreferrer">Go by Example 中文 (studygolang.com)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="http://books.studygolang.com/gopl-zh/" target="_blank" rel="noopener noreferrer">前言 · Go语言圣经 (studygolang.com)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://silenceper.com/wechat/" target="_blank" rel="noopener noreferrer">简介 · 微信开发sdk文档 (silenceper.com)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <h2 id="go-module"><a href="#go-module" class="header-anchor">#</a> Go Module</h2> <blockquote><p>​	开启<code>go module</code>需要<code>go1.11</code>及以上版本</p></blockquote> <h3 id="打开模块"><a href="#打开模块" class="header-anchor">#</a> 打开模块</h3> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">set</span> GO111MODULE<span class="token operator">=</span>on    <span class="token comment">//windows</span>
<span class="token keyword">export</span> GO111MODULE<span class="token operator">=</span>on <span class="token comment">//linux</span>
</code></pre></div><h3 id="goproxy"><a href="#goproxy" class="header-anchor">#</a> GOPROXY</h3> <p>Go1.11之后设置GOPROXY命令为：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn
</code></pre></div><p>Go1.13之后<code>GOPROXY</code>默认值为<code>https://proxy.golang.org</code>，在国内是无法访问的，所以十分建议大家设置GOPROXY，这里我推荐使用<a href="https://studygolang.com/topics/10014" target="_blank" rel="noopener noreferrer">goproxy.cn<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>go <span class="token function">env</span> -w <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn,direct
</code></pre></div><h3 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h3> <p>执行下面的命令生成<code>go.mod</code>文件</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">go</span> mod init 项目名
</code></pre></div><p>执行下面的命令创建<code>vendor</code>目录存放并下载依赖</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">go</span> mod vendor
</code></pre></div><p>执行完成会生成<code>go.sum</code>文件来记录所依赖的项目的版本的锁定</p> <p>然后在需要使用包的文件中正常<code>import</code>即可</p> <h3 id="引入新的包"><a href="#引入新的包" class="header-anchor">#</a> 引入新的包</h3> <p>在需要使用包的文件中<code>import</code>，然后再次执行下面的命令即可</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">go</span> mod vendor
</code></pre></div><h3 id="依赖包整理"><a href="#依赖包整理" class="header-anchor">#</a> 依赖包整理</h3> <p>执行下面的命令可以将没用到的依赖包清除</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">go</span> mod tidy
</code></pre></div><h3 id="其他命令"><a href="#其他命令" class="header-anchor">#</a> 其他命令</h3> <p>go mod 有以下命令：</p> <table><thead><tr><th>命令</th> <th>说明</th></tr></thead> <tbody><tr><td>download</td> <td>下载依赖的module到本地cache（默认为$GOPATH/pkg/mod目录）</td></tr> <tr><td>edit</td> <td>编辑go.mod文件</td></tr> <tr><td>graph</td> <td>打印模块依赖图</td></tr> <tr><td>init</td> <td>初始化当前文件夹, 创建go.mod文件</td></tr> <tr><td>tidy</td> <td>add missing and remove unused modules(拉取缺少的模块，移除不用的模块)</td></tr> <tr><td>vendor</td> <td>make vendored copy of dependencies(将依赖复制到vendor下)</td></tr> <tr><td>verify</td> <td>verify dependencies have expected content (验证依赖是否正确）</td></tr> <tr><td>why</td> <td>explain why packages or modules are needed(解释为什么需要依赖)</td></tr></tbody></table> <h3 id="在项目中使用go-module"><a href="#在项目中使用go-module" class="header-anchor">#</a> 在项目中使用go module</h3> <h4 id="既有项目"><a href="#既有项目" class="header-anchor">#</a> 既有项目</h4> <p>如果需要对一个已经存在的项目启用<code>go module</code>，可以按照以下步骤操作：</p> <ol><li>在项目目录下执行<code>go mod init</code>，生成一个<code>go.mod</code>文件。</li> <li>执行<code>go get</code>，查找并记录当前项目的依赖，同时生成一个<code>go.sum</code>记录每个依赖库的版本和哈希值。</li></ol> <h4 id="新项目"><a href="#新项目" class="header-anchor">#</a> 新项目</h4> <p>对于一个新创建的项目，我们可以在项目文件夹下按照以下步骤操作：</p> <ol><li>执行<code>go mod init 项目名</code>命令，在当前项目文件夹下创建一个<code>go.mod</code>文件。</li> <li>手动编辑<code>go.mod</code>中的require依赖项或执行<code>go get</code>自动发现、维护依赖。</li></ol> <h1 id="golang-垃圾回收剖析"><a href="#golang-垃圾回收剖析" class="header-anchor">#</a> Golang 垃圾回收剖析</h1> <blockquote><p>文章来源：<a href="http://legendtkl.com/2017/04/28/golang-gc/" target="_blank" rel="noopener noreferrer">Golang 垃圾回收剖析 | Legendtkl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="_1-golang-gc-发展"><a href="#_1-golang-gc-发展" class="header-anchor">#</a> 1. Golang GC 发展</h2> <p>Golang 从第一个版本以来，GC 一直是大家诟病最多的。但是每一个版本的发布基本都伴随着 GC 的改进。下面列出一些比较重要的改动。</p> <ul><li>v1.1 STW</li> <li>v1.3 Mark STW, Sweep 并行</li> <li>v1.5 三色标记法</li> <li>v1.8 hybrid write barrier</li></ul> <h2 id="_2-gc-算法简介"><a href="#_2-gc-算法简介" class="header-anchor">#</a> 2. GC 算法简介</h2> <p>这一小节介绍三种经典的 GC 算法：引用计数（reference counting）、标记-清扫（mark &amp; sweep）、节点复制（Copying Garbage Collection），分代收集（Generational Garbage Collection）。</p> <h3 id="_2-1-引用计数"><a href="#_2-1-引用计数" class="header-anchor">#</a> 2.1 引用计数</h3> <p>引用计数的思想非常简单：每个单元维护一个域，保存其它单元指向它的引用数量（类似有向图的入度）。当引用数量为 0 时，将其回收。引用计数是渐进式的，能够将内存管理的开销分布到整个程序之中。C++ 的 share_ptr 使用的就是引用计算方法。</p> <p>引用计数算法实现一般是把所有的单元放在一个单元池里，比如类似 free list。这样所有的单元就被串起来了，就可以进行引用计数了。新分配的单元计数值被设置为 1（注意不是 0，因为申请一般都说 ptr = new object 这种）。每次有一个指针被设为指向该单元时，该单元的计数值加 1；而每次删除某个指向它的指针时，它的计数值减 1。当其引用计数为 0 的时候，该单元会被进行回收。虽然这里说的比较简单，实现的时候还是有很多细节需要考虑，比如删除某个单元的时候，那么它指向的所有单元都需要对引用计数减 1。那么如果这个时候，发现其中某个指向的单元的引用计数又为 0，那么是递归的进行还是采用其他的策略呢？递归处理的话会导致系统颠簸。关于这些细节这里就不讨论了，可以参考文章后面的给的参考资料。</p> <h5 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h5> <ol><li>渐进式。内存管理与用户程序的执行交织在一起，将 GC 的代价分散到整个程序。不像标记-清扫算法需要 STW (Stop The World，GC 的时候挂起用户程序)。</li> <li>算法易于实现。</li> <li>内存单元能够很快被回收。相比于其他垃圾回收算法，堆被耗尽或者达到某个阈值才会进行垃圾回收。</li></ol> <h5 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h5> <ol><li>原始的引用计数不能处理循环引用。大概这是被诟病最多的缺点了。不过针对这个问题，也除了很多解决方案，比如强引用等。</li> <li>维护引用计数降低运行效率。内存单元的更新删除等都需要维护相关的内存单元的引用计数，相比于一些追踪式的垃圾回收算法并不需要这些代价。</li> <li>单元池 free list 实现的话不是 cache-friendly 的，这样会导致频繁的 cache miss，降低程序运行效率。</li></ol> <h3 id="_2-2-标记-清扫"><a href="#_2-2-标记-清扫" class="header-anchor">#</a> 2.2 标记-清扫</h3> <p>标记-清扫算法是第一种自动内存管理，基于追踪的垃圾收集算法。算法思想在 70 年代就提出了，是一种非常古老的算法。内存单元并不会在变成垃圾立刻回收，而是保持不可达状态，直到到达某个阈值或者固定时间长度。这个时候系统会挂起用户程序，也就是 STW，转而执行垃圾回收程序。垃圾回收程序对所有的存活单元进行一次全局遍历确定哪些单元可以回收。算法分两个部分：标记（mark）和清扫（sweep）。标记阶段表明所有的存活单元，清扫阶段将垃圾单元回收。可视化可以参考下图。</p> <p><img src="/Users/guozhiyuan/Downloads/Animation_of_the_Naive_Mark_and_Sweep_Garbage_Collector_Algorithm.gif" alt="Animation_of_the_Naive_Mark_and_Sweep_Garbage_Collector_Algorithm"></p> <p>标记-清扫算法的优点也就是基于追踪的垃圾回收算法具有的优点：避免了引用计数算法的缺点（不能处理循环引用，需要维护指针）。缺点也很明显，需要 STW。</p> <h5 id="三色标记算法"><a href="#三色标记算法" class="header-anchor">#</a> 三色标记算法</h5> <p>三色标记算法是对标记阶段的改进，原理如下：</p> <ol><li>起初所有对象都是白色。</li> <li>从根出发扫描所有可达对象，标记为灰色，放入待处理队列。</li> <li>从队列取出灰色对象，将其引用对象标记为灰色放入队列，自身标记为黑色。</li> <li>重复 3，直到灰色对象队列为空。此时白色对象即为垃圾，进行回收。</li></ol> <p>可视化如下。</p> <p><img src="/Users/guozhiyuan/Downloads/Animation_of_tri-color_garbage_collection.gif" alt="Animation_of_tri-color_garbage_collection"></p> <p>三色标记的一个明显好处是能够让用户程序和 mark 并发的进行，具体可以参考论文：《On-the-fly garbage collection: an exercise in cooperation.》。Golang 的 GC 实现也是基于这篇论文，后面再具体说明。</p> <h3 id="_2-3-节点复制"><a href="#_2-3-节点复制" class="header-anchor">#</a> 2.3 节点复制</h3> <p>节点复制也是基于追踪的算法。其将整个堆等分为两个半区（semi-space），一个包含现有数据，另一个包含已被废弃的数据。节点复制式垃圾收集从切换（flip）两个半区的角色开始，然后收集器在老的半区，也就是 Fromspace 中遍历存活的数据结构，在第一次访问某个单元时把它复制到新半区，也就是 Tospace 中去。在 Fromspace 中所有存活单元都被访问过之后，收集器在 Tospace 中建立一个存活数据结构的副本，用户程序可以重新开始运行了。</p> <h5 id="优点-2"><a href="#优点-2" class="header-anchor">#</a> 优点</h5> <ol><li>所有存活的数据结构都缩并地排列在 Tospace 的底部，这样就不会存在内存碎片的问题。</li> <li>获取新内存可以简单地通过递增自由空间指针来实现。</li></ol> <h5 id="缺点-2"><a href="#缺点-2" class="header-anchor">#</a> 缺点</h5> <ol><li>内存得不到充分利用，总有一半的内存空间处于浪费状态。</li></ol> <h3 id="_2-4-分代收集"><a href="#_2-4-分代收集" class="header-anchor">#</a> 2.4 分代收集</h3> <p>基于追踪的垃圾回收算法（标记-清扫、节点复制）一个主要问题是在生命周期较长的对象上浪费时间（长生命周期的对象是不需要频繁扫描的）。同时，内存分配存在这么一个事实 “most object die young”。基于这两点，分代垃圾回收算法将对象按生命周期长短存放到堆上的两个（或者更多）区域，这些区域就是分代（generation）。对于新生代的区域的垃圾回收频率要明显高于老年代区域。</p> <p>分配对象的时候从新生代里面分配，如果后面发现对象的生命周期较长，则将其移到老年代，这个过程叫做 promote。随着不断 promote，最后新生代的大小在整个堆的占用比例不会特别大。收集的时候集中主要精力在新生代就会相对来说效率更高，STW 时间也会更短。</p> <h5 id="优点-3"><a href="#优点-3" class="header-anchor">#</a> 优点</h5> <ol><li>性能更优。</li></ol> <h5 id="缺点-3"><a href="#缺点-3" class="header-anchor">#</a> 缺点</h5> <ol><li>实现复杂</li></ol> <h2 id="_3-golang-gc"><a href="#_3-golang-gc" class="header-anchor">#</a> 3. Golang GC</h2> <h3 id="_3-1-overview"><a href="#_3-1-overview" class="header-anchor">#</a> 3.1 Overview</h3> <p>在说 Golang 的具体垃圾回收流程时，我们先来看一下几个基本的问题。</p> <h5 id="_1-何时触发-gc"><a href="#_1-何时触发-gc" class="header-anchor">#</a> 1. 何时触发 GC</h5> <p>在堆上分配大于 32K byte 对象的时候进行检测此时是否满足垃圾回收条件，如果满足则进行垃圾回收。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>size <span class="token builtin">uintptr</span><span class="token punctuation">,</span> typ <span class="token operator">*</span>_type<span class="token punctuation">,</span> needzero <span class="token builtin">bool</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    shouldhelpgc <span class="token operator">:=</span> <span class="token boolean">false</span>
    <span class="token comment">// 分配的对象小于 32K byte</span>
    <span class="token keyword">if</span> size <span class="token operator">&lt;=</span> maxSmallSize <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        shouldhelpgc <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token comment">// gcShouldStart() 函数进行触发条件检测</span>
    <span class="token keyword">if</span> shouldhelpgc <span class="token operator">&amp;&amp;</span> <span class="token function">gcShouldStart</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// gcStart() 函数进行垃圾回收</span>
        <span class="token function">gcStart</span><span class="token punctuation">(</span>gcBackgroundMode<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面是自动垃圾回收，还有一种是主动垃圾回收，通过调用 runtime.GC()，这是阻塞式的。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// GC runs a garbage collection and blocks the caller until the</span>
<span class="token comment">// garbage collection is complete. It may also block the entire</span>
<span class="token comment">// program.</span>
<span class="token keyword">func</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">gcStart</span><span class="token punctuation">(</span>gcForceBlockMode<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2-gc-触发条件"><a href="#_2-gc-触发条件" class="header-anchor">#</a> 2. GC 触发条件</h5> <p>触发条件主要关注下面代码中的中间部分：<code>forceTrigger || memstats.heap_live &gt;= memstats.gc_trigger</code> 。forceTrigger 是 forceGC 的标志；后面半句的意思是当前堆上的活跃对象大于我们初始化时候设置的 GC 触发阈值。在 malloc 以及 free 的时候 heap_live 会一直进行更新，这里就不再展开了。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// gcShouldStart returns true if the exit condition for the _GCoff</span>
<span class="token comment">// phase has been met. The exit condition should be tested when</span>
<span class="token comment">// allocating.</span>
<span class="token comment">//</span>
<span class="token comment">// If forceTrigger is true, it ignores the current heap size, but</span>
<span class="token comment">// checks all other conditions. In general this should be false.</span>
<span class="token keyword">func</span> <span class="token function">gcShouldStart</span><span class="token punctuation">(</span>forceTrigger <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> gcphase <span class="token operator">==</span> _GCoff <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>forceTrigger <span class="token operator">||</span> memstats<span class="token punctuation">.</span>heap_live <span class="token operator">&gt;=</span> memstats<span class="token punctuation">.</span>gc_trigger<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> memstats<span class="token punctuation">.</span>enablegc <span class="token operator">&amp;&amp;</span> panicking <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> gcpercent <span class="token operator">&gt;=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">//初始化的时候设置 GC 的触发阈值</span>
<span class="token keyword">func</span> <span class="token function">gcinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token function">setGCPercent</span><span class="token punctuation">(</span><span class="token function">readgogc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    memstats<span class="token punctuation">.</span>gc_trigger <span class="token operator">=</span> heapminimum
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// 启动的时候通过 GOGC 传递百分比 x</span>
<span class="token comment">// 触发阈值等于 x * defaultHeapMinimum (defaultHeapMinimum 默认是 4M)</span>
<span class="token keyword">func</span> <span class="token function">readgogc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int32</span> <span class="token punctuation">{</span>
    p <span class="token operator">:=</span> <span class="token function">gogetenv</span><span class="token punctuation">(</span><span class="token string">&quot;GOGC&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> p <span class="token operator">==</span> <span class="token string">&quot;off&quot;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> n<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">atoi32</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> n
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">100</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_3-垃圾回收的主要流程"><a href="#_3-垃圾回收的主要流程" class="header-anchor">#</a> 3. 垃圾回收的主要流程</h5> <p>三色标记法，主要流程如下：</p> <ul><li>所有对象最开始都是白色。</li> <li>从 root 开始找到所有可达对象，标记为灰色，放入待处理队列。</li> <li>遍历灰色对象队列，将其引用对象标记为灰色放入待处理队列，自身标记为黑色。</li> <li>处理完灰色对象队列，执行清扫工作。</li></ul> <p>详细的过程如下图所示，具体可参考 [9]。
<img src="/Users/guozhiyuan/Downloads/gc.png" alt="gc"></p> <p>关于上图有几点需要说明的是。</p> <ol><li>首先从 root 开始遍历，root 包括全局指针和 goroutine 栈上的指针。</li> <li>mark 有两个过程。
<ol><li>从 root 开始遍历，标记为灰色。遍历灰色队列。</li> <li>re-scan 全局指针和栈。因为 mark 和用户程序是并行的，所以在过程 1 的时候可能会有新的对象分配，这个时候就需要通过写屏障（write barrier）记录下来。re-scan 再完成检查一下。</li></ol></li> <li>Stop The World 有两个过程。
<ol><li>第一个是 GC 将要开始的时候，这个时候主要是一些准备工作，比如 enable write barrier。</li> <li>第二个过程就是上面提到的 re-scan 过程。如果这个时候没有 stw，那么 mark 将无休止。</li></ol></li></ol> <p>另外针对上图各个阶段对应 GCPhase 如下：</p> <ul><li>Off: _GCoff</li> <li>Stack scan ~ Mark: _GCmark</li> <li>Mark termination: _GCmarktermination</li></ul> <h3 id="_3-2-写屏障-write-barrier"><a href="#_3-2-写屏障-write-barrier" class="header-anchor">#</a> 3.2 写屏障 (write barrier)</h3> <p>关于 write barrier，完全可以另外写成一篇文章，所以这里只简单介绍一下，这篇文章的重点还是 Golang 的 GC。垃圾回收中的 write barrier 可以理解为编译器在写操作时特意插入的一段代码，对应的还有 read barrier。</p> <p>为什么需要 write barrier，很简单，对于和用户程序并发运行的垃圾回收算法，用户程序会一直修改内存，所以需要记录下来。</p> <p>Golang 1.7 之前的 write barrier 使用的经典的 Dijkstra-style insertion write barrier [Dijkstra ‘78]， STW 的主要耗时就在 stack re-scan 的过程。自 1.8 之后采用一种混合的 write barrier 方式 （Yuasa-style deletion write barrier [Yuasa ‘90] 和 Dijkstra-style insertion write barrier [Dijkstra ‘78]）来避免 re-scan。具体的可以参考 <a href="https://github.com/golang/proposal/blob/master/design/17503-eliminate-rescan.md" target="_blank" rel="noopener noreferrer">17503-eliminate-rescan<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="_3-3-标记"><a href="#_3-3-标记" class="header-anchor">#</a> 3.3 标记</h3> <p>下面的源码还是基于 go1.8rc3。这个版本的 GC 代码相比之前改动还是挺大的，我们下面尽量只关注主流程。垃圾回收的代码主要集中在函数 <code>gcStart()</code> 中。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// gcStart 是 GC 的入口函数，根据 gcMode 做处理。</span>
<span class="token comment">// 1. gcMode == gcBackgroundMode（后台运行，也就是并行）, _GCoff -&gt; _GCmark</span>
<span class="token comment">// 2. 否则 GCoff -&gt; _GCmarktermination，这个时候就是主动 GC </span>
<span class="token keyword">func</span> <span class="token function">gcStart</span><span class="token punctuation">(</span>mode gcMode<span class="token punctuation">,</span> forceTrigger <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_1-stw-phase-1"><a href="#_1-stw-phase-1" class="header-anchor">#</a> 1. STW phase 1</h5> <p>在 GC 开始之前的准备工作。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcStart</span><span class="token punctuation">(</span>mode gcMode<span class="token punctuation">,</span> forceTrigger <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">//在后台启动 mark worker </span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> gcBackgroundMode <span class="token punctuation">{</span>
        <span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token comment">// Stop The World</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span>stopTheWorldWithSema<span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> gcBackgroundMode <span class="token punctuation">{</span>
        <span class="token comment">// GC 开始前的准备工作</span>

        <span class="token comment">//处理设置 GCPhase，setGCPhase 还会 enable write barrier</span>
        <span class="token function">setGCPhase</span><span class="token punctuation">(</span>_GCmark<span class="token punctuation">)</span>
      	
        <span class="token function">gcBgMarkPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Must happen before assist enable.</span>
        <span class="token function">gcMarkRootPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// Mark all active tinyalloc blocks. Since we're</span>
        <span class="token comment">// allocating from these, they need to be black like</span>
        <span class="token comment">// other allocations. The alternative is to blacken</span>
        <span class="token comment">// the tiny block on every allocation from it, which</span>
        <span class="token comment">// would slow down the tiny allocator.</span>
        <span class="token function">gcMarkTinyAllocs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      	
        <span class="token comment">// Start The World</span>
        <span class="token function">systemstack</span><span class="token punctuation">(</span>startTheWorldWithSema<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2-mark"><a href="#_2-mark" class="header-anchor">#</a> 2. Mark</h5> <p>Mark 阶段是并行的运行，通过在后台一直运行 mark worker 来实现。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcStart</span><span class="token punctuation">(</span>mode gcMode<span class="token punctuation">,</span> forceTrigger <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">//在后台启动 mark worker </span>
    <span class="token keyword">if</span> mode <span class="token operator">==</span> gcBackgroundMode <span class="token punctuation">{</span>
        <span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Background marking is performed by per-P G's. Ensure that</span>
    <span class="token comment">// each P has a background GC G.</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token operator">&amp;</span>allp <span class="token punctuation">{</span>
        <span class="token keyword">if</span> p <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> p<span class="token punctuation">.</span>status <span class="token operator">==</span> _Pdead <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> p<span class="token punctuation">.</span>gcBgMarkWorker <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">go</span> <span class="token function">gcBgMarkWorker</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
            <span class="token function">notetsleepg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">noteclear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// gcBgMarkWorker 是一直在后台运行的，大部分时候是休眠状态，通过 gcController 来调度</span>
<span class="token keyword">func</span> <span class="token function">gcBgMarkWorker</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将当前 goroutine 休眠，直到满足某些条件</span>
        <span class="token function">gopark</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token operator">...</span>
        <span class="token comment">// mark 过程</span>
        <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mark our goroutine preemptible so its stack</span>
        <span class="token comment">// can be scanned. This lets two mark workers</span>
        <span class="token comment">// scan each other (otherwise, they would</span>
        <span class="token comment">// deadlock). We must not modify anything on</span>
        <span class="token comment">// the G stack. However, stack shrinking is</span>
        <span class="token comment">// disabled for mark workers, so it is safe to</span>
        <span class="token comment">// read from the G stack.</span>
        <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunning<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">)</span>
        <span class="token keyword">switch</span> _p_<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token punctuation">{</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;gcBgMarkWorker: unexpected gcMarkWorkerMode&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> gcMarkWorkerDedicatedMode<span class="token punctuation">:</span>
            <span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainNoBlock<span class="token operator">|</span>gcDrainFlushBgCredit<span class="token punctuation">)</span>
        <span class="token keyword">case</span> gcMarkWorkerFractionalMode<span class="token punctuation">:</span>
            <span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainUntilPreempt<span class="token operator">|</span>gcDrainFlushBgCredit<span class="token punctuation">)</span>
        <span class="token keyword">case</span> gcMarkWorkerIdleMode<span class="token punctuation">:</span>
            <span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainIdle<span class="token operator">|</span>gcDrainUntilPreempt<span class="token operator">|</span>gcDrainFlushBgCredit<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Mark 阶段的标记代码主要在函数 gcDrain() 中实现。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// gcDrain scans roots and objects in work buffers, blackening grey</span>
<span class="token comment">// objects until all roots and work buffers have been drained.</span>
<span class="token keyword">func</span> <span class="token function">gcDrain</span><span class="token punctuation">(</span>gcw <span class="token operator">*</span>gcWork<span class="token punctuation">,</span> flags gcDrainFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>	
    <span class="token comment">// Drain root marking jobs.</span>
    <span class="token keyword">if</span> work<span class="token punctuation">.</span>markrootNext <span class="token operator">&lt;</span> work<span class="token punctuation">.</span>markrootJobs <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token operator">!</span><span class="token punctuation">(</span>preemptible <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span>preempt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            job <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>markrootNext<span class="token punctuation">,</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token keyword">if</span> job <span class="token operator">&gt;=</span> work<span class="token punctuation">.</span>markrootJobs <span class="token punctuation">{</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            <span class="token function">markroot</span><span class="token punctuation">(</span>gcw<span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token keyword">if</span> idle <span class="token operator">&amp;&amp;</span> <span class="token function">pollWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">goto</span> done
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  	
    <span class="token comment">// 处理 heap 标记</span>
    <span class="token comment">// Drain heap marking jobs.</span>
    <span class="token keyword">for</span> <span class="token operator">!</span><span class="token punctuation">(</span>preemptible <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span>preempt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token comment">//从灰色列队中取出对象</span>
        <span class="token keyword">var</span> b <span class="token builtin">uintptr</span>
        <span class="token keyword">if</span> blocking <span class="token punctuation">{</span>
            b <span class="token operator">=</span> gcw<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            b <span class="token operator">=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGetFast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                b <span class="token operator">=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token comment">// work barrier reached or tryGet failed.</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//扫描灰色对象的引用对象，标记为灰色，入灰色队列</span>
        <span class="token function">scanobject</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> gcw<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_3-mark-termination-stw-phase-2"><a href="#_3-mark-termination-stw-phase-2" class="header-anchor">#</a> 3. Mark termination (STW phase 2)</h5> <p>mark termination 阶段会 stop the world。函数实现在 <code>gcMarkTermination()</code>。1.8 版本已经不会再对 goroutine stack 进行 re-scan 了。细节有点多，这里不细说了。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcMarkTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// World is stopped.</span>
    <span class="token comment">// Run gc on the g0 stack. We do this so that the g stack</span>
    <span class="token comment">// we're currently running on will no longer change. Cuts</span>
    <span class="token comment">// the root set down a bit (g0 stacks are not scanned, and</span>
    <span class="token comment">// we don't need to scan gc's internal state).  We also</span>
    <span class="token comment">// need to switch to g0 so we can shrink the stack.</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">gcMark</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span>
        <span class="token comment">// Must return immediately.</span>
        <span class="token comment">// The outer function's stack may have moved</span>
        <span class="token comment">// during gcMark (it shrinks stacks, including the</span>
        <span class="token comment">// outer function's stack), so we must not refer</span>
        <span class="token comment">// to any of its variables. Return back to the</span>
        <span class="token comment">// non-system stack to pick up the new addresses</span>
        <span class="token comment">// before continuing.</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-4-清扫"><a href="#_3-4-清扫" class="header-anchor">#</a> 3.4 清扫</h3> <p>清扫相对来说就简单很多了。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcSweep</span><span class="token punctuation">(</span>mode gcMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">//阻塞式</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>_ConcurrentSweep <span class="token operator">||</span> mode <span class="token operator">==</span> gcForceBlockMode <span class="token punctuation">{</span>
        <span class="token comment">// Special case synchronous sweep.</span>
        <span class="token operator">...</span>
        <span class="token comment">// Sweep all spans eagerly.</span>
        <span class="token keyword">for</span> <span class="token function">sweepone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">^</span><span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sweep<span class="token punctuation">.</span>npausesweep<span class="token operator">++</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Do an additional mProf_GC, because all 'free' events are now real as well.</span>
        <span class="token function">mProf_GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">mProf_GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
  	
    <span class="token comment">// 并行式</span>
    <span class="token comment">// Background sweep.</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sweep<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
    <span class="token keyword">if</span> sweep<span class="token punctuation">.</span>parked <span class="token punctuation">{</span>
        sweep<span class="token punctuation">.</span>parked <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token function">ready</span><span class="token punctuation">(</span>sweep<span class="token punctuation">.</span>g<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sweep<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于并行式清扫，在 GC 初始化的时候就会启动 <code>bgsweep()</code>，然后在后台一直循环。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">bgsweep</span><span class="token punctuation">(</span>c <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sweep<span class="token punctuation">.</span>g <span class="token operator">=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sweep<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
    sweep<span class="token punctuation">.</span>parked <span class="token operator">=</span> <span class="token boolean">true</span>
    c <span class="token operator">&lt;-</span> <span class="token number">1</span>
    <span class="token function">goparkunlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sweep<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">&quot;GC sweep wait&quot;</span><span class="token punctuation">,</span> traceEvGoBlock<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token function">gosweepone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">^</span><span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sweep<span class="token punctuation">.</span>nbgsweep<span class="token operator">++</span>
            <span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sweep<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">gosweepdone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// This can happen if a GC runs between</span>
            <span class="token comment">// gosweepone returning ^0 above</span>
            <span class="token comment">// and the lock being acquired.</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sweep<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        sweep<span class="token punctuation">.</span>parked <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">goparkunlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sweep<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">&quot;GC sweep wait&quot;</span><span class="token punctuation">,</span> traceEvGoBlock<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">gosweepone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uintptr</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ret <span class="token builtin">uintptr</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">sweepone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre></div><p>不管是阻塞式还是并行式，都是通过 <code>sweepone()</code>函数来做清扫工作的。如果对于上篇文章 <a href="http://legendtkl.com/2017/04/02/golang-alloc/" target="_blank" rel="noopener noreferrer">Golang 内存管理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 熟悉的话，这个地方就很好理解。内存管理都是基于 span 的，mheap_ 是一个全局的变量，所有分配的对象都会记录在 mheap_ 中。在标记的时候，我们只要找到对对象对应的 span 进行标记，清扫的时候扫描 span，没有标记的 span 就可以回收了。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// sweeps one span</span>
<span class="token comment">// returns number of pages returned to heap, or ^uintptr(0) if there is nothing to sweep</span>
<span class="token keyword">func</span> <span class="token function">sweepone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uintptr</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        s <span class="token operator">:=</span> mheap_<span class="token punctuation">.</span>sweepSpans<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span>sg<span class="token operator">/</span><span class="token number">2</span><span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">...</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Span is still in-use, so this returned no</span>
            <span class="token comment">// pages to the heap and the span needs to</span>
            <span class="token comment">// move to the swept in-use list.</span>
            npages <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Sweep frees or collects finalizers for blocks not marked in the mark phase.</span>
<span class="token comment">// It clears the mark bits in preparation for the next GC round.</span>
<span class="token comment">// Returns true if the span was returned to heap.</span>
<span class="token comment">// If preserve=true, don't return it to heap nor relink in MCentral lists;</span>
<span class="token comment">// caller takes care of it.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>mspan<span class="token punctuation">)</span> <span class="token function">sweep</span><span class="token punctuation">(</span>preserve <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-5-其他"><a href="#_3-5-其他" class="header-anchor">#</a> 3.5 其他</h3> <h5 id="_1-gcwork"><a href="#_1-gcwork" class="header-anchor">#</a> 1. gcWork</h5> <p>这里介绍一下任务队列，或者说灰色对象管理。每个 P 上都有一个 gcw 用来管理灰色对象（get 和 put），gcw 的结构就是 gcWork。gcWork 中的核心是 wbuf1 和 wbuf2，里面存储就是灰色对象，或者说是 work（下面就全部统一叫做 work）。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    gcw gcWork
<span class="token punctuation">}</span>

<span class="token keyword">type</span> gcWork <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// wbuf1 and wbuf2 are the primary and secondary work buffers.</span>
    wbuf1<span class="token punctuation">,</span> wbuf2 wbufptr
  
    <span class="token comment">// Bytes marked (blackened) on this gcWork. This is aggregated</span>
    <span class="token comment">// into work.bytesMarked by dispose.</span>
    bytesMarked <span class="token builtin">uint64</span>

    <span class="token comment">// Scan work performed on this gcWork. This is aggregated into</span>
    <span class="token comment">// gcController by dispose and may also be flushed by callers.</span>
    scanWork <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
</code></pre></div><p>既然每个 P 上有一个 work buffer，那么是不是还有一个全局的 work list 呢？是的。通过在每个 P 上绑定一个 work buffer 的好处和 cache 一样，不需要加锁。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> work <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    full  <span class="token builtin">uint64</span>                   <span class="token comment">// lock-free list of full blocks workbuf</span>
    empty <span class="token builtin">uint64</span>                   <span class="token comment">// lock-free list of empty blocks workbuf</span>
    pad0  <span class="token punctuation">[</span>sys<span class="token punctuation">.</span>CacheLineSize<span class="token punctuation">]</span><span class="token builtin">uint8</span> <span class="token comment">// prevents false-sharing between full/empty and nproc/nwait</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么为什么使用两个 work buffer （wbuf1 和 wbuf2）呢？我下面举个例子。比如我现在要 get 一个 work 出来，先从 wbuf1 中取，wbuf1 为空的话则与 wbuf2 swap 再 get。在其他时间将 work buffer 中的 full 或者 empty buffer 移到 global 的 work 中。这样的好处在于，在 get 的时候去全局的 work 里面取（多个 goroutine 去取会有竞争）。这里有趣的是 global 的 work list 是 lock-free 的，通过原子操作 cas 等实现。下面列举几个函数看一下 gcWrok。</p> <p>初始化。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>gcWork<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    w<span class="token punctuation">.</span>wbuf1 <span class="token operator">=</span> <span class="token function">wbufptrOf</span><span class="token punctuation">(</span><span class="token function">getempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    wbuf2 <span class="token operator">:=</span> <span class="token function">trygetfull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> wbuf2 <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        wbuf2 <span class="token operator">=</span> <span class="token function">getempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    w<span class="token punctuation">.</span>wbuf2 <span class="token operator">=</span> <span class="token function">wbufptrOf</span><span class="token punctuation">(</span>wbuf2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>put。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// put enqueues a pointer for the garbage collector to trace.</span>
<span class="token comment">// obj must point to the beginning of a heap object or an oblet.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>gcWork<span class="token punctuation">)</span> <span class="token function">put</span><span class="token punctuation">(</span>obj <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wbuf <span class="token operator">:=</span> w<span class="token punctuation">.</span>wbuf1<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> wbuf <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        wbuf <span class="token operator">=</span> w<span class="token punctuation">.</span>wbuf1<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// wbuf is empty at this point.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> wbuf<span class="token punctuation">.</span>nobj <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>wbuf<span class="token punctuation">.</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span>wbuf1<span class="token punctuation">,</span> w<span class="token punctuation">.</span>wbuf2 <span class="token operator">=</span> w<span class="token punctuation">.</span>wbuf2<span class="token punctuation">,</span> w<span class="token punctuation">.</span>wbuf1
        wbuf <span class="token operator">=</span> w<span class="token punctuation">.</span>wbuf1<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> wbuf<span class="token punctuation">.</span>nobj <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>wbuf<span class="token punctuation">.</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">putfull</span><span class="token punctuation">(</span>wbuf<span class="token punctuation">)</span>
            wbuf <span class="token operator">=</span> <span class="token function">getempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            w<span class="token punctuation">.</span>wbuf1 <span class="token operator">=</span> <span class="token function">wbufptrOf</span><span class="token punctuation">(</span>wbuf<span class="token punctuation">)</span>
            flushed <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    wbuf<span class="token punctuation">.</span>obj<span class="token punctuation">[</span>wbuf<span class="token punctuation">.</span>nobj<span class="token punctuation">]</span> <span class="token operator">=</span> obj
    wbuf<span class="token punctuation">.</span>nobj<span class="token operator">++</span>
<span class="token punctuation">}</span>
</code></pre></div><p>get。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// get dequeues a pointer for the garbage collector to trace, blocking</span>
<span class="token comment">// if necessary to ensure all pointers from all queues and caches have</span>
<span class="token comment">// been retrieved.  get returns 0 if there are no pointers remaining.</span>
<span class="token comment">//go:nowritebarrier</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>gcWork<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uintptr</span> <span class="token punctuation">{</span>
    wbuf <span class="token operator">:=</span> w<span class="token punctuation">.</span>wbuf1<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> wbuf <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        wbuf <span class="token operator">=</span> w<span class="token punctuation">.</span>wbuf1<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// wbuf is empty at this point.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> wbuf<span class="token punctuation">.</span>nobj <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span>wbuf1<span class="token punctuation">,</span> w<span class="token punctuation">.</span>wbuf2 <span class="token operator">=</span> w<span class="token punctuation">.</span>wbuf2<span class="token punctuation">,</span> w<span class="token punctuation">.</span>wbuf1
        wbuf <span class="token operator">=</span> w<span class="token punctuation">.</span>wbuf1<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> wbuf<span class="token punctuation">.</span>nobj <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            owbuf <span class="token operator">:=</span> wbuf
            wbuf <span class="token operator">=</span> <span class="token function">getfull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> wbuf <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>
            <span class="token function">putempty</span><span class="token punctuation">(</span>owbuf<span class="token punctuation">)</span>
            w<span class="token punctuation">.</span>wbuf1 <span class="token operator">=</span> <span class="token function">wbufptrOf</span><span class="token punctuation">(</span>wbuf<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// TODO: This might be a good place to add prefetch code</span>

    wbuf<span class="token punctuation">.</span>nobj<span class="token operator">--</span>
    <span class="token keyword">return</span> wbuf<span class="token punctuation">.</span>obj<span class="token punctuation">[</span>wbuf<span class="token punctuation">.</span>nobj<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2-forcegc"><a href="#_2-forcegc" class="header-anchor">#</a> 2. forcegc</h5> <p>我们上面讲了两种 GC 触发方式：自动检测和用户主动调用。除此之后 Golang 本身还会对运行状态进行监控，如果超过两分钟没有 GC，则触发 GC。监控函数是 <code>sysmon()</code>，在主 goroutine 中启动。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// The main goroutine</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token function">newm</span><span class="token punctuation">(</span>sysmon<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Always runs without a P, so write barriers are not allowed.</span>
<span class="token keyword">func</span> <span class="token function">sysmon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        unixnow <span class="token operator">:=</span> <span class="token function">unixnanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      	
        lastgc <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>last_gc<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> gcphase <span class="token operator">==</span> _GCoff <span class="token operator">&amp;&amp;</span> lastgc <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> unixnow<span class="token operator">-</span>lastgc <span class="token operator">&gt;</span> forcegcperiod <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>idle<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            forcegc<span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span>
            forcegc<span class="token punctuation">.</span>g<span class="token punctuation">.</span>schedlink <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token function">injectglist</span><span class="token punctuation">(</span>forcegc<span class="token punctuation">.</span>g<span class="token punctuation">)</span>	<span class="token comment">// 将 forcegc goroutine 加入 runnable queue</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> forcegcperiod <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span><span class="token number">1e9</span>	<span class="token comment">//两分钟</span>
</code></pre></div><h2 id="_4-参考资料"><a href="#_4-参考资料" class="header-anchor">#</a> 4.参考资料</h2> <ol><li>《Go 语言学习笔记》</li> <li><a href="https://book.douban.com/subject/1157908/" target="_blank" rel="noopener noreferrer">《垃圾收集》 - 豆瓣<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection#Na.C3.AFve_mark-and-sweep" target="_blank" rel="noopener noreferrer">Tracing Garbage Collection - wikipedia<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>《On-the-fly garbage collection: an exercise in cooperation.》 — Edsger W. Dijkstra, Leslie Lamport, A. J. Martin</li> <li><a href="https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)" target="_blank" rel="noopener noreferrer">Garbage Collection<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection" target="_blank" rel="noopener noreferrer">Tracing Garbage Collection<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.youtube.com/watch?v=P1rU_9IB414" target="_blank" rel="noopener noreferrer">Copying Garbage Collection – youtube<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.youtube.com/watch?v=pJHISaOW6Vc" target="_blank" rel="noopener noreferrer">Generational Garbage Collection – youtube<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://talks.golang.org/2015/go-gc.pdf" target="_blank" rel="noopener noreferrer">golang gc talk<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/golang/proposal/blob/master/design/17503-eliminate-rescan.md" target="_blank" rel="noopener noreferrer">17503-eliminate-rescan<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/super-eggs/vuepress-blog/edit/master/docs/Go/README.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/Go/mianshiti.html">
        go 面试题练习
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div class="reading-progress top" data-v-21b39eda><div class="progress" data-v-21b39eda></div></div></div></div>
    <script src="/assets/js/app.693e6c19.js" defer></script><script src="/assets/js/2.3304c2e1.js" defer></script><script src="/assets/js/24.124a82a4.js" defer></script>
  </body>
</html>
